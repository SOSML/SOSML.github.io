var Interpreter=function(t){function __webpack_require__(n){if(e[n])return e[n].exports;var i=e[n]={i:n,l:!1,exports:{}};return t[n].call(i.exports,i,i.exports,__webpack_require__),i.l=!0,i.exports}var e={};return __webpack_require__.m=t,__webpack_require__.c=e,__webpack_require__.i=function(t){return t},__webpack_require__.d=function(exports,t,e){__webpack_require__.o(exports,t)||Object.defineProperty(exports,t,{configurable:!1,enumerable:!0,get:e})},__webpack_require__.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return __webpack_require__.d(e,"a",e),e},__webpack_require__.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=8)}([function(t,exports,e){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var i=function(t){function InterpreterError(e,n){var i=t.call(this,n)||this;return i.position=e,Object.setPrototypeOf(i,InterpreterError.prototype),i}return n(InterpreterError,t),InterpreterError}(Error);exports.InterpreterError=i;var r=function(t){function InternalInterpreterError(e,n){void 0===n&&(n="internal compiler error");var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,InternalInterpreterError.prototype),i}return n(InternalInterpreterError,t),InternalInterpreterError}(i);exports.InternalInterpreterError=r;var o=function(t){function FeatureNotImplementedError(e,n){var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,FeatureNotImplementedError.prototype),i}return n(FeatureNotImplementedError,t),FeatureNotImplementedError}(i);exports.FeatureNotImplementedError=o;var a=function(t){function FeatureDisabledError(e,n){var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,FeatureDisabledError.prototype),i}return n(FeatureDisabledError,t),FeatureDisabledError}(i);exports.FeatureDisabledError=a;var s=function(t){function IncompleteError(e,n){void 0===n&&(n="unexpected end of input");var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,IncompleteError.prototype),i}return n(IncompleteError,t),IncompleteError}(i);exports.IncompleteError=s;var u=function(t){function LexerError(e,n){var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,LexerError.prototype),i}return n(LexerError,t),LexerError}(i);exports.LexerError=u;var p=function(t){function ParserError(e,n){var i=t.call(this,n,e)||this;return Object.setPrototypeOf(i,ParserError.prototype),i}return n(ParserError,t),ParserError}(i);exports.ParserError=p;var c=function(t){function ElaborationError(e,n){var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,ElaborationError.prototype),i}return n(ElaborationError,t),ElaborationError.getUnguarded=function(t,e){var n="";e.length>1&&(n+="s"),n+=" ";for(var i=0;i<e.length;++i)i>0&&(n+=", "),n+='"'+e[i].name+'"';return new ElaborationError(t,"Unguarded type variable"+n+".")},ElaborationError}(i);exports.ElaborationError=c;var h=function(t){function EvaluationError(e,n){var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,EvaluationError.prototype),i}return n(EvaluationError,t),EvaluationError}(i);exports.EvaluationError=h;var l=function(t){function Warning(e,n){var i=t.call(this,e,n)||this;return Object.setPrototypeOf(i,Warning.prototype),i}return n(Warning,t),Warning}(i);exports.Warning=l},function(t,exports,e){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var i=function(){function KeywordToken(t,e){this.text=t,this.position=e}return KeywordToken.prototype.getText=function(){return this.text},KeywordToken.prototype.isValidRecordLabel=function(){return!1},KeywordToken.prototype.isVid=function(){return!1},KeywordToken}();exports.KeywordToken=i;var r=function(){function ConstantToken(){}return ConstantToken.prototype.isVid=function(){return!1},ConstantToken}();exports.ConstantToken=r;var o=function(t){function IntegerConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(IntegerConstantToken,t),IntegerConstantToken.prototype.getText=function(){return""+this.value},IntegerConstantToken.prototype.isValidRecordLabel=function(){return!1},IntegerConstantToken}(r);exports.IntegerConstantToken=o;var a=function(t){function RealConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(RealConstantToken,t),RealConstantToken.prototype.getText=function(){return""+this.value},RealConstantToken.prototype.isValidRecordLabel=function(){return!1},RealConstantToken}(r);exports.RealConstantToken=a;var s=function(t){function WordConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(WordConstantToken,t),WordConstantToken.prototype.getText=function(){return""+this.value},WordConstantToken.prototype.isValidRecordLabel=function(){return!1},WordConstantToken}(r);exports.WordConstantToken=s;var u=function(t){function CharacterConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(CharacterConstantToken,t),CharacterConstantToken.prototype.getText=function(){return""+this.text},CharacterConstantToken.prototype.isValidRecordLabel=function(){return!1},CharacterConstantToken}(r);exports.CharacterConstantToken=u;var p=function(t){function StringConstantToken(e,n,i){var r=t.call(this)||this;return r.text=e,r.position=n,r.value=i,r}return n(StringConstantToken,t),StringConstantToken.prototype.getText=function(){return""+this.text},StringConstantToken.prototype.isValidRecordLabel=function(){return!1},StringConstantToken}(r);exports.StringConstantToken=p;var c=function(){function IdentifierToken(t,e){this.text=t,this.position=e,this.opPrefixed=!1}return IdentifierToken.prototype.getText=function(){return this.text},IdentifierToken.prototype.isValidRecordLabel=function(){return!0},IdentifierToken.prototype.isVid=function(){return!0},IdentifierToken}();exports.IdentifierToken=c;var h=function(t){function AlphanumericIdentifierToken(e,n){return t.call(this,e,n)||this}return n(AlphanumericIdentifierToken,t),AlphanumericIdentifierToken.prototype.getText=function(){return this.text},AlphanumericIdentifierToken.prototype.isValidRecordLabel=function(){return!0},AlphanumericIdentifierToken}(c);exports.AlphanumericIdentifierToken=h;var l=function(){function TypeVariableToken(t,e){this.text=t,this.position=e}return TypeVariableToken.prototype.getText=function(){return this.text},TypeVariableToken.prototype.isValidRecordLabel=function(){return!1},TypeVariableToken.prototype.isVid=function(){return!1},TypeVariableToken}();exports.TypeVariableToken=l;var f=function(t){function EqualityTypeVariableToken(e,n){return t.call(this,e,n)||this}return n(EqualityTypeVariableToken,t),EqualityTypeVariableToken.prototype.getText=function(){return this.text},EqualityTypeVariableToken.prototype.isValidRecordLabel=function(){return!1},EqualityTypeVariableToken.prototype.isVid=function(){return!1},EqualityTypeVariableToken}(l);exports.EqualityTypeVariableToken=f;var d=function(t){function StarToken(e){var n=t.call(this,"*",e)||this;return n.position=e,n.opPrefixed=!1,n}return n(StarToken,t),StarToken.prototype.getText=function(){return this.text},StarToken.prototype.isValidRecordLabel=function(){return!0},StarToken.prototype.isVid=function(){return!0},StarToken}(i);exports.StarToken=d;var y=function(t){function EqualsToken(e){var n=t.call(this,"=",e)||this;return n.position=e,n}return n(EqualsToken,t),EqualsToken.prototype.getText=function(){return this.text},EqualsToken.prototype.isValidRecordLabel=function(){return!1},EqualsToken.prototype.isVid=function(){return!0},EqualsToken}(i);exports.EqualsToken=y;var v=function(t){function NumericToken(e,n,i){return t.call(this,e,n,i)||this}return n(NumericToken,t),NumericToken.prototype.getText=function(){return this.text},NumericToken.prototype.isValidRecordLabel=function(){return!0},NumericToken.prototype.isVid=function(){return!1},NumericToken}(o);exports.NumericToken=v;var w=function(){function LongIdentifierToken(t,e,n,i){this.text=t,this.position=e,this.qualifiers=n,this.id=i,this.opPrefixed=!1}return LongIdentifierToken.prototype.getText=function(){for(var t="",e=0;e<this.qualifiers.length;++e)e>0&&(t+="."),t+=this.qualifiers[e].getText();return t+"."+this.id.getText()},LongIdentifierToken.prototype.isValidRecordLabel=function(){return!1},LongIdentifierToken.prototype.isVid=function(){return!1},LongIdentifierToken}();exports.LongIdentifierToken=w},function(t,exports,e){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var n,i=e(4),r=e(1),o=e(0);!function(t){t[t.VALUE_VARIABLE=0]="VALUE_VARIABLE",t[t.VALUE_CONSTRUCTOR=1]="VALUE_CONSTRUCTOR",t[t.EXCEPTION_CONSTRUCTOR=2]="EXCEPTION_CONSTRUCTOR"}(n=exports.IdentifierStatus||(exports.IdentifierStatus={}));var a=function(){function TypeInformation(t,e){this.type=t,this.constructors=e}return TypeInformation}();exports.TypeInformation=a;var s=function(){function TypeNameInformation(t,e){this.arity=t,this.allowsEquality=e}return TypeNameInformation}();exports.TypeNameInformation=s;var u=function(){function InfixStatus(t,e,n){void 0===e&&(e=0),void 0===n&&(n=!1),this.infix=t,this.precedence=e,this.rightAssociative=n}return InfixStatus}();exports.InfixStatus=u;var p;!function(t){t[t.Never=0]="Never",t[t.Half=1]="Half",t[t.Allowed=2]="Allowed"}(p=exports.RebindStatus||(exports.RebindStatus={}));var c=function(){function DynamicBasis(t,e){this.typeEnvironment=t,this.valueEnvironment=e}return DynamicBasis.prototype.getValue=function(t){return this.valueEnvironment[t]},DynamicBasis.prototype.getType=function(t){return this.typeEnvironment[t]},DynamicBasis.prototype.setValue=function(t,e,n){this.valueEnvironment[t]=[e,n]},DynamicBasis.prototype.setType=function(t,e){this.typeEnvironment[t]=e},DynamicBasis}();exports.DynamicBasis=c;var h=function(){function StaticBasis(t,e){this.typeEnvironment=t,this.valueEnvironment=e}return StaticBasis.prototype.getValue=function(t){return this.valueEnvironment[t]},StaticBasis.prototype.getType=function(t){return this.typeEnvironment[t]},StaticBasis.prototype.setValue=function(t,e,n){this.valueEnvironment[t]=[e,n]},StaticBasis.prototype.setType=function(t,e,n){this.typeEnvironment[t]=new a(e,n)},StaticBasis}();exports.StaticBasis=h;var l=function(){function State(t,e,n,i,r,o,a,s,u,p){void 0===u&&(u={}),void 0===p&&(p=new Set),this.id=t,this.parent=e,this.staticBasis=n,this.dynamicBasis=i,this.memory=r,this.typeNames=o,this.infixEnvironment=a,this.rebindEnvironment=s,this.valueIdentifierId=u,this.declaredIdentifiers=p}return State.prototype.getDefinedIdentifiers=function(t){void 0===t&&(t=0);var e=new Set;return void 0!==this.parent&&this.parent.id>=t&&(e=this.parent.getDefinedIdentifiers()),this.declaredIdentifiers.forEach(function(t){e.add(t)}),e},State.prototype.getNestedState=function(t){return void 0===t&&(t=void 0),void 0===t&&(t=this.id+1),new State(t,this,new h({},{}),new c({},{}),[this.memory[0],{}],{},{},{})},State.prototype.getCell=function(t){return void 0!==this.memory[1][t]?this.memory[1][t]:void 0===this.parent?void 0:this.parent.getCell(t)},State.prototype.getRebindStatus=function(t,e){return void 0===e&&(e=0),void 0!==this.rebindEnvironment[t]?this.rebindEnvironment[t]:void 0===this.parent||this.parent.id<e?p.Allowed:void 0===this.rebindEnvironment[t]?this.parent.getRebindStatus(t):p.Half},State.prototype.getStaticValue=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getValue(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticValue(t,e)},State.prototype.getStaticType=function(t,e){void 0===e&&(e=0);var n=this.staticBasis.getType(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getStaticType(t,e)},State.prototype.getDynamicValue=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getValue(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicValue(t,e)},State.prototype.getDynamicType=function(t,e){void 0===e&&(e=0);var n=this.dynamicBasis.getType(t);return void 0!==n||void 0===this.parent||this.parent.id<e?n:this.parent.getDynamicType(t,e)},State.prototype.getInfixStatus=function(t,e){if(void 0===e&&(e=0),t.isVid()||t instanceof r.LongIdentifierToken)return this.infixEnvironment.hasOwnProperty(t.getText())||!this.parent||this.parent.id<e?this.infixEnvironment[t.getText()]:this.parent.getInfixStatus(t,e);throw new o.InternalInterpreterError(t.position,'You gave me some "'+t.getText()+'" ('+t.constructor.name+") but I only want (Long)IdentifierToken.")},State.prototype.getCustomType=function(t,e){return void 0===e&&(e=0),this.typeNames.hasOwnProperty(t)||!this.parent||this.parent.id<e?this.typeNames[t]:this.parent.getCustomType(t,e)},State.prototype.getValueIdentifierId=function(t,e){return void 0===e&&(e=0),this.valueIdentifierId.hasOwnProperty(t)?this.valueIdentifierId[t]:!this.parent||this.parent.id<e?0:this.parent.getValueIdentifierId(t,e)},State.prototype.incrementValueIdentifierId=function(t,e){if(void 0===e&&(e=void 0),void 0===e||this.id===e)this.valueIdentifierId[t]=this.getValueIdentifierId(t,e)+1;else{if(e>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+e+'" does not exist.');this.parent.incrementValueIdentifierId(t,e)}},State.prototype.setCell=function(t,e){t>=this.memory[0]&&(this.memory[0]=t+1),this.memory[1][t]=e},State.prototype.setNewCell=function(t){return this.memory[1][this.memory[0]]=t,new i.ReferenceValue(this.memory[0]++)},State.prototype.setStaticValue=function(t,e,n,i){if(void 0===i&&(i=void 0),void 0===i||i===this.id)this.staticBasis.setValue(t,e,n);else{if(i>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+i+'" does not exist.');this.parent.setStaticValue(t,e,n,i)}},State.prototype.setStaticType=function(t,e,n,i){if(void 0===i&&(i=void 0),void 0===i||i===this.id)this.staticBasis.setType(t,e,n);else{if(i>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+i+'" does not exist.');this.parent.setStaticType(t,e,n,i)}},State.prototype.setDynamicValue=function(t,e,i,r){if(void 0===r&&(r=void 0),void 0===r||r===this.id){if(this.rebindEnvironment[t]===p.Never)throw new o.EvaluationError(-1,'How could you ever want to redefine "'+t+'".');this.dynamicBasis.setValue(t,e,i),this.declaredIdentifiers.add(t),i!==n.VALUE_VARIABLE?this.rebindEnvironment[t]=p.Half:this.rebindEnvironment[t]=p.Allowed}else{if(r>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+r+'" does not exist.');this.parent.setDynamicValue(t,e,i,r)}},State.prototype.setDynamicType=function(t,e,n){if(void 0===n&&(n=void 0),void 0===n||n===this.id)this.dynamicBasis.setType(t,e),this.declaredIdentifiers.add(t);else{if(n>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+n+'" does not exist.');this.parent.setDynamicType(t,e,n)}},State.prototype.setInfixStatus=function(t,e,n,i,a){if(void 0===a&&(a=void 0),void 0===a||a===this.id)(t.isVid()||t instanceof r.LongIdentifierToken)&&(this.infixEnvironment[t.getText()]=new u(i,e,n));else{if(a>this.id||void 0===this.parent)throw new o.InternalInterpreterError(-1,'State with id "'+a+'" does not exist.');this.parent.setInfixStatus(t,e,n,i,a)}},State}();exports.State=l},function(t,exports,e){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var i=e(0),r=function(){function Type(){}return Type.prototype.instantiate=function(t){return this.simplify().instantiate(t)},Type.prototype.getTypeVariables=function(t){return this.simplify().getTypeVariables(t)},Type.prototype.matches=function(t,e){return this.simplify().matches(t,e)},Type.prototype.simplify=function(){return this},Type.prototype.admitsEquality=function(t){return!1},Type}();exports.Type=r;var o=function(t){function TypeVariable(e,n,i,r){void 0===n&&(n=!0),void 0===i&&(i=0),void 0===r&&(r=[]);var o=t.call(this)||this;return o.name=e,o.isFree=n,o.position=i,o.domain=r,o}return n(TypeVariable,t),TypeVariable.prototype.kill=function(){return 0===this.domain.length?this:this.domain[0]},TypeVariable.prototype.prettyPrint=function(){return this.name},TypeVariable.prototype.instantiate=function(t){var e=t.getStaticValue(this.name);if(!this.isFree||void 0===e||e[0].equals(this))return this;if(0===this.domain.length)return e[0];if(e[0]instanceof TypeVariable&&0!==e[0].domain.length){for(var n=[],r=0;r<this.domain.length;++r)for(var o=0;o<e[0].domain.length;++o)this.domain[r].equals(e[0].domain[o])&&n.push(this.domain[r]);if(n.length>0)return new TypeVariable(e[0].name,e[0].isFree,e[0].position,n)}else for(var r=0;r<this.domain.length;++r)if(this.domain[r].equals(e[0]))return e[0];throw new i.ElaborationError(this.position,'Cannot instanciate "'+this.prettyPrint()+'" with "'+e[0].prettyPrint()+'".')},TypeVariable.prototype.getTypeVariables=function(t){var e=new Set;return t===this.isFree&&e.add(this),e},TypeVariable.prototype.matches=function(t,e){throw new Error("ニャ－")},TypeVariable.prototype.admitsEquality=function(t){for(var e=0;e<this.domain.length;++e)if(!this.domain[e].admitsEquality(t))return!1;return 0!==this.domain.length||"'"===this.name[1]},TypeVariable.prototype.equals=function(t){if(!(t instanceof TypeVariable&&this.name===t.name))return!1;if(this.domain.length!==t.domain.length)return!1;for(var e=0;e<this.domain.length;++e)if(!this.domain[e].equals(t.domain[e]))return!1;return!0},TypeVariable}(r);exports.TypeVariable=o;var a=function(t){function RecordType(e,n,i){void 0===n&&(n=!0),void 0===i&&(i=0);var r=t.call(this)||this;return r.elements=e,r.complete=n,r.position=i,r}return n(RecordType,t),RecordType.prototype.instantiate=function(t){var e=new Map;return this.elements.forEach(function(n,i){e.set(i,n.instantiate(t))}),new RecordType(e,this.complete)},RecordType.prototype.getTypeVariables=function(t){var e=new Set;return this.elements.forEach(function(n){n.getTypeVariables(t).forEach(function(t){e.add(t)})}),e},RecordType.prototype.matches=function(t,e){throw new Error("ニャ－")},RecordType.prototype.admitsEquality=function(t){var e=!0;return this.elements.forEach(function(n,i){n.admitsEquality(t)||(e=!1)}),e},RecordType.prototype.prettyPrint=function(){for(var t=!0,e=1;e<=this.elements.size;++e)this.elements.has(""+e)||(t=!1);if(t){for(var n="(",e=1;e<=this.elements.size;++e){e>1&&(n+=" * ");var r=this.elements.get(""+e);if(void 0===r)throw new i.InternalInterpreterError(-1,"How did we loose this value? It was there before. I promise…");n+=r.prettyPrint()}return n+")"}var o="{",a=!0;return this.elements.forEach(function(t,e){a?a=!1:o+=", ",o+=e+" : "+t.prettyPrint()}),this.complete||(a||(o+=", "),o+="..."),o+"}"},RecordType.prototype.simplify=function(){var t=new Map;return this.elements.forEach(function(e,n){t.set(n,e.simplify())}),new RecordType(t,this.complete,this.position)},RecordType.prototype.equals=function(t){if(!(t instanceof RecordType&&this.complete===t.complete))return!1;if(t===this)return!0;for(var e in this.elements)if(!this.elements.hasOwnProperty(e)&&!this.elements.get(e).equals(t.elements.get(e)))return!1;for(var n in t.elements)if(!t.elements.hasOwnProperty(n)&&!t.elements.get(n).equals(this.elements.get(n)))return!1;return!0},RecordType}(r);exports.RecordType=a;var s=function(t){function FunctionType(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.parameterType=e,r.returnType=n,r.position=i,r}return n(FunctionType,t),FunctionType.prototype.instantiate=function(t){return new FunctionType(this.parameterType.instantiate(t),this.returnType.instantiate(t),this.position)},FunctionType.prototype.getTypeVariables=function(t){var e=new Set;return this.parameterType.getTypeVariables(t).forEach(function(t){e.add(t)}),this.returnType.getTypeVariables(t).forEach(function(t){e.add(t)}),e},FunctionType.prototype.matches=function(t,e){throw new Error("ニャ－")},FunctionType.prototype.admitsEquality=function(t){return this.parameterType.admitsEquality(t)&&this.returnType.admitsEquality(t)},FunctionType.prototype.prettyPrint=function(){return"("+this.parameterType.prettyPrint()+" -> "+this.returnType.prettyPrint()+")"},FunctionType.prototype.simplify=function(){return new FunctionType(this.parameterType.simplify(),this.returnType.simplify(),this.position)},FunctionType.prototype.equals=function(t){return t instanceof FunctionType&&this.parameterType.equals(t.parameterType)&&this.returnType.equals(t.returnType)},FunctionType}(r);exports.FunctionType=s;var u=function(t){function CustomType(e,n,i){void 0===n&&(n=[]),void 0===i&&(i=0);var r=t.call(this)||this;return r.name=e,r.typeArguments=n,r.position=i,r}return n(CustomType,t),CustomType.prototype.instantiate=function(t){for(var e=[],n=0;n<this.typeArguments.length;++n)e.push(this.typeArguments[n].instantiate(t));return new CustomType(this.name,e,this.position)},CustomType.prototype.getTypeVariables=function(t){var e=new Set;if(this.typeArguments.length>0)for(var n=0;n<this.typeArguments.length;++n)this.typeArguments[n].getTypeVariables(t).forEach(function(t){e.add(t)});return e},CustomType.prototype.matches=function(t,e){throw new Error("ニャ－")},CustomType.prototype.admitsEquality=function(t){for(var e=0;e<this.typeArguments.length;++e)if(!this.typeArguments[e].admitsEquality(t))return!1;return!0},CustomType.prototype.prettyPrint=function(){var t="";this.typeArguments.length>1&&(t+="(");for(var e=0;e<this.typeArguments.length;++e)e>0&&(t+=", "),t+=this.typeArguments[e].prettyPrint();return this.typeArguments.length>1&&(t+=")"),this.typeArguments.length>0&&(t+=" "),t+=this.name},CustomType.prototype.simplify=function(){for(var t=[],e=0;e<this.typeArguments.length;++e)t.push(this.typeArguments[e].simplify());return new CustomType(this.name,t,this.position)},CustomType.prototype.equals=function(t){if(!(t instanceof CustomType)||this.name!==t.name)return!1;for(var e=0;e<this.typeArguments.length;++e)if(!this.typeArguments[e].equals(t.typeArguments[e]))return!1;return!0},CustomType}(r);exports.CustomType=u;var p=function(t){function TupleType(e,n){void 0===n&&(n=0);var i=t.call(this)||this;return i.elements=e,i.position=n,i}return n(TupleType,t),TupleType.prototype.prettyPrint=function(){for(var t="(",e=0;e<this.elements.length;++e)e>0&&(t+=" * "),t+=this.elements[e].prettyPrint();return t+")"},TupleType.prototype.simplify=function(){for(var t=new Map,e=0;e<this.elements.length;++e)t.set(""+(e+1),this.elements[e].simplify());return new a(t,!0,this.position)},TupleType.prototype.equals=function(t){return this.simplify().equals(t)},TupleType}(r);exports.TupleType=p},function(t,exports,e){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var i=e(2),r=e(0),o=e(1),a=function(){function Value(){}return Value.prototype.equals=function(t){throw new r.InternalInterpreterError(-1,"Tried comparing incomparable things.")},Value}();exports.Value=a;var s=function(t){function ReferenceValue(e){var n=t.call(this)||this;return n.address=e,n}return n(ReferenceValue,t),ReferenceValue.prototype.equals=function(t){return this.address===t.address},ReferenceValue.prototype.prettyPrint=function(t){if(void 0===t)return"$"+this.address;if(void 0!==t.getCell(this.address))return"ref "+t.getCell(this.address).prettyPrint(t);throw new r.EvaluationError(-1,'Ouch, you may not de-reference "$'+this.address+'".')},ReferenceValue}(a);exports.ReferenceValue=s;var u=function(t){function BoolValue(e){var n=t.call(this)||this;return n.value=e,n}return n(BoolValue,t),BoolValue.prototype.equals=function(t){return this.value===t.value},BoolValue.prototype.prettyPrint=function(t){return this.value?"true":"false"},BoolValue}(a);exports.BoolValue=u;var p=function(t){function CharValue(e){var n=t.call(this)||this;return n.value=e,n}return n(CharValue,t),CharValue.prototype.prettyPrint=function(t){return"#"+new c(this.value).prettyPrint(t)},CharValue.prototype.compareTo=function(t){return this.value<t.value?-1:this.value>t.value?1:0},CharValue.prototype.equals=function(t){return this.value===t.value},CharValue}(a);exports.CharValue=p;var c=function(t){function StringValue(e){var n=t.call(this)||this;return n.value=e,n}return n(StringValue,t),StringValue.implode=function(t){for(var e="";"nil"!==t.constructorName;){if("::"!==t.constructorName)throw new r.InternalInterpreterError(-1,"Is this a char list? I can't implode \""+t.constructorName+'".');var n=t.argument;if(!(n instanceof d))throw new r.InternalInterpreterError(-1,"Is this a char list? I can't implode \""+t.constructorName+'".');var i=n.getValue("1"),o=n.getValue("2");if(!(i instanceof p&&o instanceof v))throw new r.InternalInterpreterError(-1,"Is this a char list? I can't implode \""+t.constructorName+'".');e+=i.value,t=o}return new StringValue(e)},StringValue.prototype.prettyPrint=function(t){for(var e="",n=0,i=this.value;n<i.length;n++){var r=i[n];switch(r){case"\n":e+="\\n";break;case"\t":e+="\\t";break;case"\r":e+="\\r";break;case"":e+="\\a";break;case"\b":e+="\\b";break;case"\v":e+="\\v";break;case"\f":e+="\\f";break;case"":e+="\\127";break;case"ÿ":e+="\\255";break;default:r.charCodeAt(0)<32?e+="\\^"+String.fromCharCode(r.charCodeAt(0)+64):e+=r}}return'"'+e+'"'},StringValue.prototype.equals=function(t){return this.value===t.value},StringValue.prototype.compareTo=function(t){return this.value<t.value?-1:this.value>t.value?1:0},StringValue.prototype.concat=function(t){return new StringValue(this.value+t.value)},StringValue.prototype.explode=function(){for(var t=new v("nil"),e=this.value.length-1;e>=0;--e)t=new v("::",new d(new Map([["1",new p(this.value[e])],["2",t]])));return t},StringValue}(a);exports.StringValue=c;var h=function(t){function Word(e){var n=t.call(this)||this;return n.value=e,n}return n(Word,t),Word.prototype.prettyPrint=function(t){return""+this.value},Word.prototype.compareTo=function(t){if(t instanceof Word){var e=t.value;return this.value<e?-1:this.value>e?1:0}return 2},Word.prototype.negate=function(){return new Word(-this.value)},Word.prototype.equals=function(t){return 0===this.compareTo(t)},Word.prototype.add=function(t){return new Word(this.value+t.value)},Word.prototype.multiply=function(t){return new Word(this.value*t.value)},Word.prototype.divide=function(t){return new Word(Math.floor(this.value/t.value))},Word.prototype.modulo=function(t){return new Word(this.value%t.value)},Word.prototype.toReal=function(){return new f(this.value)},Word.prototype.hasOverflow=function(){return this.value>1073741823||this.value<-1073741824},Word}(a);exports.Word=h;var l=function(t){function Integer(e){var n=t.call(this)||this;return n.value=e,n}return n(Integer,t),Integer.prototype.prettyPrint=function(t){return""+this.value},Integer.prototype.compareTo=function(t){if(t instanceof Integer){var e=t.value;return this.value<e?-1:this.value>e?1:0}return!1},Integer.prototype.equals=function(t){return 0===this.compareTo(t)},Integer.prototype.negate=function(){return new Integer(-this.value)},Integer.prototype.add=function(t){return new Integer(this.value+t.value)},Integer.prototype.multiply=function(t){return new Integer(this.value*t.value)},Integer.prototype.divide=function(t){return new Integer(Math.floor(this.value/t.value))},Integer.prototype.modulo=function(t){return new Integer(this.value%t.value)},Integer.prototype.toReal=function(){return new f(this.value)},Integer.prototype.hasOverflow=function(){return this.value>1073741823||this.value<-1073741824},Integer}(a);exports.Integer=l;var f=function(t){function Real(e){var n=t.call(this)||this;return n.value=e,n}return n(Real,t),Real.prototype.prettyPrint=function(t){var e=""+this.value;return-1===e.search(/\./)&&(e+=".0"),e},Real.prototype.compareTo=function(t){if(t instanceof Real){var e=t.value;return this.value<e?-1:this.value>e?1:0}return!1},Real.prototype.equals=function(t){return 0===this.compareTo(t)},Real.prototype.negate=function(){return new Real(-this.value)},Real.prototype.add=function(t){return new Real(this.value+t.value)},Real.prototype.multiply=function(t){return new Real(this.value*t.value)},Real.prototype.divide=function(t){return new Real(this.value/t.value)},Real.prototype.toInteger=function(){return new l(Math.floor(this.value))},Real.prototype.hasOverflow=function(){return!1},Real}(a);exports.Real=f;var d=function(t){function RecordValue(e){void 0===e&&(e=new Map);var n=t.call(this)||this;return n.entries=e,n}return n(RecordValue,t),RecordValue.prototype.prettyPrint=function(t){for(var e=!0,n=1;n<=this.entries.size;++n)this.entries.has(""+n)||(e=!1);if(e){for(var i="(",n=1;n<=this.entries.size;++n){n>1&&(i+=", ");var o=this.entries.get(""+n);if(void 0===o)throw new r.InternalInterpreterError(-1,"How did we loose this value? It was there before. I promise…");i+=o.prettyPrint(t)}return i+")"}var a="{ ",s=!0;return this.entries.forEach(function(e,n){s?s=!1:a+=", ",a+=n+" = "+e.prettyPrint(t)}),a+" }"},RecordValue.prototype.getValue=function(t){if(!this.entries.has(t))throw new r.EvaluationError(0,"Tried accessing non-existing record part.");return this.entries.get(t)},RecordValue.prototype.hasValue=function(t){return this.entries.has(t)},RecordValue.prototype.equals=function(t){var e=this;if(!(t instanceof RecordValue))return!1;var n=!1;return this.entries.forEach(function(e,i){t.entries.has(i)||(n=!0),e.equals(t.entries.get(i))||(n=!0)}),!n&&(t.entries.forEach(function(i,r){e.entries.has(r)||(n=!0),i.equals(t.entries.get(r))||(n=!0)}),!n)},RecordValue}(a);exports.RecordValue=d;var y=function(t){function FunctionValue(e,n,i){var r=t.call(this)||this;return r.state=e,r.recursives=n,r.body=i,r}return n(FunctionValue,t),FunctionValue.prototype.prettyPrint=function(t){return"fn"},FunctionValue.prototype.compute=function(t,e){for(var n=this.state.getNestedState(this.state.id),r=0;r<this.recursives.length;++r)this.recursives[r][1]instanceof FunctionValue?n.setDynamicValue(this.recursives[r][0],new FunctionValue(this.state,this.recursives,this.recursives[r][1].body),i.IdentifierStatus.VALUE_VARIABLE):n.setDynamicValue(this.recursives[r][0],this.recursives[r][1],i.IdentifierStatus.VALUE_VARIABLE);for(var r=0;r<e.length;++r)n.setCell(e[r][0],e[r][1]);return this.body.compute(n,t)},FunctionValue.prototype.equals=function(t){throw new r.InternalInterpreterError(-1,'You simply cannot compare "'+this.prettyPrint(void 0)+'" and "'+t.prettyPrint(void 0)+'".')},FunctionValue}(a);exports.FunctionValue=y;var v=function(t){function ConstructedValue(e,n,i){void 0===n&&(n=void 0),void 0===i&&(i=0);var r=t.call(this)||this;return r.constructorName=e,r.argument=n,r.id=i,r}return n(ConstructedValue,t),ConstructedValue.prototype.prettyPrint=function(t){if("::"===this.constructorName){for(var e="[",n=this;"nil"!==n.constructorName;){if("::"!==n.constructorName)throw new r.InternalInterpreterError(-1,'Is this even a list? 1 "'+n.constructorName+'".');var i=n.argument;if(!(i instanceof d&&2===i.entries.size))throw new r.InternalInterpreterError(-1,'Is this even a list? 3 "'+n.constructorName+'".');var s=i.getValue("1"),u=i.getValue("2");if(!(s instanceof a&&u instanceof ConstructedValue))throw new r.InternalInterpreterError(-1,'Is this even a list? 2 "'+n.constructorName+'".');n!==this&&(e+=", "),e+=s.prettyPrint(t),n=u}return e+"]"}if("nil"===this.constructorName)return"[]";if(void 0!==t){var p=t.getInfixStatus(new o.IdentifierToken(this.constructorName,-1));if(void 0!==p&&p.infix&&this.argument instanceof d&&2===this.argument.entries.size){var c=this.argument.getValue("1"),h=this.argument.getValue("1");if(c instanceof a&&h instanceof a){var e="("+c.prettyPrint(t);return e+=" "+this.constructorName,this.id>0&&(e+="/"+this.id),(e+=" "+h.prettyPrint(t))+")"}}}var l=this.constructorName;return this.id>0&&(l+="/"+this.id),this.argument&&(l+=" "+this.argument.prettyPrint(t)),l},ConstructedValue.prototype.equals=function(t){return t instanceof m&&(t=t.construct()),t instanceof ConstructedValue&&(this.constructorName===t.constructorName&&this.id===t.id&&(void 0!==this.argument?void 0===t.argument||this.argument.equals(t.argument):void 0===t.argument))},ConstructedValue}(a);exports.ConstructedValue=v;var w=function(t){function ExceptionValue(e,n,i){void 0===n&&(n=void 0),void 0===i&&(i=0);var r=t.call(this)||this;return r.constructorName=e,r.argument=n,r.id=i,r}return n(ExceptionValue,t),ExceptionValue.prototype.prettyPrint=function(t){var e=this.constructorName;return this.id>0&&(e+="/"+this.id),this.argument&&(e+=" "+this.argument.prettyPrint(t)),e},ExceptionValue.prototype.equals=function(t){return t instanceof g&&(t=t.construct()),t instanceof ExceptionValue&&(this.constructorName===t.constructorName&&this.id===t.id&&(void 0!==this.argument?void 0===t.argument||this.argument.equals(t.argument):void 0===t.argument))},ExceptionValue}(a);exports.ExceptionValue=w;var T=function(t){function PredefinedFunction(e,n){var i=t.call(this)||this;return i.name=e,i.apply=n,i}return n(PredefinedFunction,t),PredefinedFunction.prototype.prettyPrint=function(t){return"fn"},PredefinedFunction.prototype.equals=function(t){return t instanceof PredefinedFunction&&this.name===t.name},PredefinedFunction}(a);exports.PredefinedFunction=T;var m=function(t){function ValueConstructor(e,n,i){void 0===n&&(n=0),void 0===i&&(i=0);var r=t.call(this)||this;return r.constructorName=e,r.numArgs=n,r.id=i,r}return n(ValueConstructor,t),ValueConstructor.prototype.equals=function(t){return t instanceof ValueConstructor&&(this.constructorName===t.constructorName&&this.id===t.id)},ValueConstructor.prototype.construct=function(t){return void 0===t&&(t=void 0),new v(this.constructorName,t,this.id)},ValueConstructor.prototype.prettyPrint=function(t){var e=this.constructorName;return this.id>0&&(e+="/"+this.id),e},ValueConstructor}(a);exports.ValueConstructor=m;var g=function(t){function ExceptionConstructor(e,n,i){void 0===n&&(n=0),void 0===i&&(i=0);var r=t.call(this)||this;return r.exceptionName=e,r.numArgs=n,r.id=i,r}return n(ExceptionConstructor,t),ExceptionConstructor.prototype.equals=function(t){return t instanceof ExceptionConstructor&&(this.exceptionName===t.exceptionName&&this.id===t.id)},ExceptionConstructor.prototype.construct=function(t){return void 0===t&&(t=void 0),new w(this.exceptionName,t,this.id)},ExceptionConstructor.prototype.prettyPrint=function(t){var e=this.exceptionName;return this.id>0&&(e+="/"+this.id),e},ExceptionConstructor}(a);exports.ExceptionConstructor=g},function(t,exports,e){"use strict";function functionType(t){return new i.FunctionType(new i.TupleType([t,t]),t).simplify()}function bfunctionType(t){return new i.FunctionType(new i.TupleType([t,t]),s).simplify()}function getInitialState(){return v.getNestedState()}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(2),i=e(3),r=e(4),o=e(0),a=new i.CustomType("real"),s=new i.CustomType("bool"),u=new i.CustomType("string"),p=new i.CustomType("char"),c=new i.TypeVariable("'a"),h=new i.TypeVariable("''b"),l=new i.TypeVariable("*iw",!0,0,[new i.CustomType("int"),new i.CustomType("word")]),f=new i.TypeVariable("*ir",!0,0,[new i.CustomType("int"),new i.CustomType("real")]),d=new i.TypeVariable("*iwr",!0,0,[new i.CustomType("int"),new i.CustomType("word"),new i.CustomType("real")]),y=new i.TypeVariable("*any",!0,0,[new i.CustomType("int"),new i.CustomType("word"),new i.CustomType("real"),new i.CustomType("string"),new i.CustomType("char")]),v=new n.State(0,void 0,new n.StaticBasis({unit:new n.TypeInformation(new i.FunctionType(new i.TupleType([]),new i.TupleType([])).simplify(),[]),bool:new n.TypeInformation(new i.CustomType("bool"),["true","false"]),int:new n.TypeInformation(new i.CustomType("int"),[]),word:new n.TypeInformation(new i.CustomType("word"),[]),real:new n.TypeInformation(new i.CustomType("real"),[]),string:new n.TypeInformation(new i.CustomType("string"),[]),char:new n.TypeInformation(new i.CustomType("char"),[]),list:new n.TypeInformation(new i.CustomType("list",[c]),["nil","::"]),array:new n.TypeInformation(new i.CustomType("array",[c]),[]),ref:new n.TypeInformation(new i.CustomType("ref",[c]),["ref"]),exn:new n.TypeInformation(new i.CustomType("exn"),[])},{div:[functionType(l),n.IdentifierStatus.VALUE_VARIABLE],mod:[functionType(l),n.IdentifierStatus.VALUE_VARIABLE],"*":[functionType(d),n.IdentifierStatus.VALUE_VARIABLE],"/":[functionType(a),n.IdentifierStatus.VALUE_VARIABLE],"+":[functionType(d),n.IdentifierStatus.VALUE_VARIABLE],"-":[functionType(d),n.IdentifierStatus.VALUE_VARIABLE],"<":[bfunctionType(y),n.IdentifierStatus.VALUE_VARIABLE],"<=":[bfunctionType(y),n.IdentifierStatus.VALUE_VARIABLE],">":[bfunctionType(y),n.IdentifierStatus.VALUE_VARIABLE],">=":[bfunctionType(y),n.IdentifierStatus.VALUE_VARIABLE],"=":[new i.FunctionType(new i.TupleType([h,h]),s).simplify(),n.IdentifierStatus.VALUE_VARIABLE],"<>":[new i.FunctionType(new i.TupleType([h,h]),s).simplify(),n.IdentifierStatus.VALUE_VARIABLE],true:[new i.CustomType("bool"),n.IdentifierStatus.VALUE_CONSTRUCTOR],false:[new i.CustomType("bool"),n.IdentifierStatus.VALUE_CONSTRUCTOR],nil:[new i.CustomType("list",[c]),n.IdentifierStatus.VALUE_CONSTRUCTOR],"::":[new i.FunctionType(new i.TupleType([c,new i.CustomType("list",[c])]),new i.CustomType("list",[c])).simplify(),n.IdentifierStatus.VALUE_CONSTRUCTOR],Match:[new i.CustomType("exn"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Bind:[new i.CustomType("exn"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Div:[new i.CustomType("exn"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Overflow:[new i.CustomType("exn"),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],"^":[functionType(u),n.IdentifierStatus.VALUE_VARIABLE],explode:[new i.FunctionType(u,new i.CustomType("list",[p])).simplify(),n.IdentifierStatus.VALUE_VARIABLE],implode:[new i.FunctionType(new i.CustomType("list",[p]),u).simplify(),n.IdentifierStatus.VALUE_VARIABLE],"~":[new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE],abs:[new i.FunctionType(f,f),n.IdentifierStatus.VALUE_VARIABLE],print:[new i.FunctionType(c,new i.TupleType([])).simplify(),n.IdentifierStatus.VALUE_VARIABLE],printLn:[new i.FunctionType(c,new i.TupleType([])).simplify(),n.IdentifierStatus.VALUE_VARIABLE],":=":[new i.FunctionType(new i.TupleType([new i.CustomType("ref",[c]),c]),new i.TupleType([])).simplify(),n.IdentifierStatus.VALUE_VARIABLE],ref:[new i.FunctionType(c,new i.CustomType("ref",[c])),n.IdentifierStatus.VALUE_CONSTRUCTOR],"!":[new i.FunctionType(new i.CustomType("ref",[c]),c),n.IdentifierStatus.VALUE_VARIABLE]}),new n.DynamicBasis({unit:[],bool:["true","false"],int:[],word:[],real:[],string:[],char:[],list:["nil","::"],array:[],ref:["ref"],exn:[]},{div:[new r.PredefinedFunction("div",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer)return 0===n.value?[new r.ExceptionConstructor("Div").construct(),!0,[]]:[e.divide(n),!1,[]];if(e instanceof r.Word&&n instanceof r.Word)return 0===n.value?[new r.ExceptionConstructor("Div").construct(),!0,[]]:[e.divide(n),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "div" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],mod:[new r.PredefinedFunction("mod",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer)return 0===n.value?[new r.ExceptionConstructor("Div").construct(),!0,[]]:[e.modulo(n),!1,[]];if(e instanceof r.Word&&n instanceof r.Word)return 0===n.value?[new r.ExceptionConstructor("Div").construct(),!0,[]]:[e.modulo(n),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "mod" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"*":[new r.PredefinedFunction("*",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer){var i=e.multiply(n);return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}if(e instanceof r.Word&&n instanceof r.Word){var i=e.multiply(n);return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}if(e instanceof r.Real&&n instanceof r.Real){var i=e.multiply(n);return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}}throw new o.InternalInterpreterError(-1,'Called "*" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"/":[new r.PredefinedFunction("/",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Real&&n instanceof r.Real)return 0===n.value?[new r.ExceptionConstructor("Div").construct(),!0,[]]:[e.divide(n),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "/" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"+":[new r.PredefinedFunction("+",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer){var i=e.add(n);return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}if(e instanceof r.Word&&n instanceof r.Word){var i=e.add(n);return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}if(e instanceof r.Real&&n instanceof r.Real){var i=e.add(n);return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}}throw new o.InternalInterpreterError(-1,'Called "+" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"-":[new r.PredefinedFunction("-",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer){var i=e.add(n.negate());return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}if(e instanceof r.Word&&n instanceof r.Word){var i=e.add(n.negate());return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}if(e instanceof r.Real&&n instanceof r.Real){var i=e.add(n.negate());return i.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[i,!1,[]]}}throw new o.InternalInterpreterError(-1,'Called "-" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"<":[new r.PredefinedFunction("<",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer)return[new r.BoolValue(e.compareTo(n)<0),!1,[]];if(e instanceof r.Word&&n instanceof r.Word)return[new r.BoolValue(e.compareTo(n)<0),!1,[]];if(e instanceof r.Real&&n instanceof r.Real)return[new r.BoolValue(e.compareTo(n)<0),!1,[]];if(e instanceof r.StringValue&&n instanceof r.StringValue)return[new r.BoolValue(e.compareTo(n)<0),!1,[]];if(e instanceof r.CharValue&&n instanceof r.CharValue)return[new r.BoolValue(e.compareTo(n)<0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "<" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],">":[new r.PredefinedFunction("<",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer)return[new r.BoolValue(e.compareTo(n)>0),!1,[]];if(e instanceof r.Word&&n instanceof r.Word)return[new r.BoolValue(e.compareTo(n)>0),!1,[]];if(e instanceof r.Real&&n instanceof r.Real)return[new r.BoolValue(e.compareTo(n)>0),!1,[]];if(e instanceof r.StringValue&&n instanceof r.StringValue)return[new r.BoolValue(e.compareTo(n)>0),!1,[]];if(e instanceof r.CharValue&&n instanceof r.CharValue)return[new r.BoolValue(e.compareTo(n)>0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called ">" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"<=":[new r.PredefinedFunction("<",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer)return[new r.BoolValue(e.compareTo(n)<=0),!1,[]];if(e instanceof r.Word&&n instanceof r.Word)return[new r.BoolValue(e.compareTo(n)<=0),!1,[]];if(e instanceof r.Real&&n instanceof r.Real)return[new r.BoolValue(e.compareTo(n)<=0),!1,[]];if(e instanceof r.StringValue&&n instanceof r.StringValue)return[new r.BoolValue(e.compareTo(n)<=0),!1,[]];if(e instanceof r.CharValue&&n instanceof r.CharValue)return[new r.BoolValue(e.compareTo(n)<=0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "<=" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],">=":[new r.PredefinedFunction("<",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Integer&&n instanceof r.Integer)return[new r.BoolValue(e.compareTo(n)>=0),!1,[]];if(e instanceof r.Word&&n instanceof r.Word)return[new r.BoolValue(e.compareTo(n)>=0),!1,[]];if(e instanceof r.Real&&n instanceof r.Real)return[new r.BoolValue(e.compareTo(n)>=0),!1,[]];if(e instanceof r.StringValue&&n instanceof r.StringValue)return[new r.BoolValue(e.compareTo(n)>=0),!1,[]];if(e instanceof r.CharValue&&n instanceof r.CharValue)return[new r.BoolValue(e.compareTo(n)>=0),!1,[]]}throw new o.InternalInterpreterError(-1,'Called ">=" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"=":[new r.PredefinedFunction("=",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");return[new r.BoolValue(e.equals(n)),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "=" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"<>":[new r.PredefinedFunction("=",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");return[new r.BoolValue(!e.equals(n)),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "<>" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],true:[new r.BoolValue(!0),n.IdentifierStatus.VALUE_CONSTRUCTOR],false:[new r.BoolValue(!1),n.IdentifierStatus.VALUE_CONSTRUCTOR],nil:[new r.ValueConstructor("nil").construct(),n.IdentifierStatus.VALUE_CONSTRUCTOR],"::":[new r.ValueConstructor("::",1),n.IdentifierStatus.VALUE_CONSTRUCTOR],Match:[new r.ExceptionConstructor("Match").construct(),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Bind:[new r.ExceptionConstructor("Bind").construct(),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Div:[new r.ExceptionConstructor("Div").construct(),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],Overflow:[new r.ExceptionConstructor("Overflow").construct(),n.IdentifierStatus.EXCEPTION_CONSTRUCTOR],"^":[new r.PredefinedFunction("^",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.StringValue&&n instanceof r.StringValue)return[e.concat(n),!1,[]]}throw new o.InternalInterpreterError(-1,'Called "^" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],explode:[new r.PredefinedFunction("explode",function(t){if(t instanceof r.StringValue)return[t.explode(),!1,[]];throw new o.InternalInterpreterError(-1,'Called "explode" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],implode:[new r.PredefinedFunction("implode",function(t){if(t instanceof r.ConstructedValue)return[r.StringValue.implode(t),!1,[]];throw new o.InternalInterpreterError(-1,'Called "explode" on value of the wrong type ('+t.constructor.name+").")}),n.IdentifierStatus.VALUE_VARIABLE],"~":[new r.PredefinedFunction("~",function(t){if(t instanceof r.Integer){var e=t.negate();return e.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[e,!1,[]]}if(t instanceof r.Real){var e=t.negate();return e.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[e,!1,[]]}throw new o.InternalInterpreterError(-1,'Called "~" on something weird.')}),n.IdentifierStatus.VALUE_VARIABLE],abs:[new r.PredefinedFunction("~",function(t){if(t instanceof r.Integer){if(t.value>=0)return[t,!1,[]];var e=t.negate();return e.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[e,!1,[]]}if(t instanceof r.Real){if(t.value>=0)return[t,!1,[]];var e=t.negate();return e.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[e,!1,[]]}throw new o.InternalInterpreterError(-1,'Called "~" on something weird.')}),n.IdentifierStatus.VALUE_VARIABLE],print:[new r.PredefinedFunction("print",function(t){var e=[];return t instanceof r.StringValue?e.push(new o.Warning(-1,t.value)):e.push(new o.Warning(-1,t.prettyPrint(void 0))),[new r.RecordValue,!1,e]}),n.IdentifierStatus.VALUE_VARIABLE],printLn:[new r.PredefinedFunction("printLn",function(t){var e=[];return t instanceof r.StringValue?e.push(new o.Warning(-1,t.value+"\n")):e.push(new o.Warning(-1,t.prettyPrint(void 0)+"\n")),[new r.RecordValue,!1,e]}),n.IdentifierStatus.VALUE_VARIABLE]}),[0,{}],{bool:new n.TypeNameInformation(0,!0),int:new n.TypeNameInformation(0,!0),real:new n.TypeNameInformation(0,!1),string:new n.TypeNameInformation(0,!0),char:new n.TypeNameInformation(0,!0),word:new n.TypeNameInformation(0,!0),list:new n.TypeNameInformation(1,!0),array:new n.TypeNameInformation(1,!0),ref:new n.TypeNameInformation(1,!0),exn:new n.TypeNameInformation(0,!1)},{div:new n.InfixStatus(!0,7,!1),mod:new n.InfixStatus(!0,7,!1),"*":new n.InfixStatus(!0,7,!1),"/":new n.InfixStatus(!0,7,!1),"+":new n.InfixStatus(!0,6,!1),"-":new n.InfixStatus(!0,6,!1),"<":new n.InfixStatus(!0,4,!1),">":new n.InfixStatus(!0,4,!1),"<=":new n.InfixStatus(!0,4,!1),">=":new n.InfixStatus(!0,4,!1),"::":new n.InfixStatus(!0,5,!0),"=":new n.InfixStatus(!0,4,!1),"<>":new n.InfixStatus(!0,4,!1),":=":new n.InfixStatus(!0,3,!1),"^":new n.InfixStatus(!0,6,!1)},{"=":n.RebindStatus.Never,":=":n.RebindStatus.Never,"!":n.RebindStatus.Never,ref:n.RebindStatus.Never,true:n.RebindStatus.Never,false:n.RebindStatus.Never,nil:n.RebindStatus.Never,"::":n.RebindStatus.Never,Match:n.RebindStatus.Half,Bind:n.RebindStatus.Half,Div:n.RebindStatus.Half,Overflow:n.RebindStatus.Half},{nil:1,"::":1,Match:1,Bind:1,Div:1,Overflow:1});exports.getInitialState=getInitialState},function(t,exports,e){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var i=e(7),r=e(1),o=e(3),a=e(2),s=e(0),u=e(4),p=function(){function Declaration(){}return Declaration.prototype.elaborate=function(t){throw new s.InternalInterpreterError(-1,"Not yet implemented.")},Declaration.prototype.evaluate=function(t){throw new s.InternalInterpreterError(-1,"Not yet implemented.")},Declaration.prototype.prettyPrint=function(t,e){throw new s.InternalInterpreterError(-1,"Not yet implemented.")},Declaration.prototype.simplify=function(){throw new s.InternalInterpreterError(-1,"Not yet implemented.")},Declaration}();exports.Declaration=p;var c=function(t){function ValueDeclaration(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.typeVariableSequence=n,o.valueBinding=i,o.id=r,o}return n(ValueDeclaration,t),ValueDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.valueBinding.length;++e)t.push(new k(this.valueBinding[e].position,this.valueBinding[e].isRecursive,this.valueBinding[e].pattern.simplify(),this.valueBinding[e].expression.simplify()));return new ValueDeclaration(this.position,this.typeVariableSequence,t,this.id)},ValueDeclaration.prototype.elaborate=function(t){return[t,[]]},ValueDeclaration.prototype.evaluate=function(t){for(var e=[],n=[],i=!1,r=[],o=0;o<this.valueBinding.length;++o){this.valueBinding[o].isRecursive&&(i=!0);var s=this.valueBinding[o].compute(t);r=r.concat(s[2]);for(var p=0;p<s[3].length;++p)t.setCell(s[3][p][0],s[3][p][1]);if(void 0!==s[1])return[t,!0,s[1],r];if(void 0===s[0])return[t,!0,new u.ExceptionValue("Bind"),r];for(var p=0;p<s[0].length;++p)i?n.push(s[0][p]):e.push(s[0][p])}for(var p=0;p<e.length;++p)t.setDynamicValue(e[p][0],e[p][1],a.IdentifierStatus.VALUE_VARIABLE);for(var p=0;p<n.length;++p)n[p][1]instanceof u.FunctionValue?t.setDynamicValue(n[p][0],new u.FunctionValue(n[p][1].state,n,n[p][1].body),a.IdentifierStatus.VALUE_VARIABLE):t.setDynamicValue(n[p][0],n[p][1],a.IdentifierStatus.VALUE_VARIABLE);return[t,!1,void 0,r]},ValueDeclaration.prototype.prettyPrint=function(t,e){for(var n="val <stuff>",i=0;i<this.valueBinding.length;++i)i>0&&(n+=" and"),n+=" "+this.valueBinding[i].prettyPrint(t,e);return n+=";"},ValueDeclaration}(p);exports.ValueDeclaration=c;var h=function(t){function TypeDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.typeBinding=n,r.id=i,r}return n(TypeDeclaration,t),TypeDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.typeBinding.length;++e)t.push(new S(this.typeBinding[e].position,this.typeBinding[e].typeVariableSequence,this.typeBinding[e].name,this.typeBinding[e].type.simplify()));return new TypeDeclaration(this.position,t,this.id)},TypeDeclaration.prototype.elaborate=function(t){for(var e=0;e<this.typeBinding.length;++e);return[t,[]]},TypeDeclaration.prototype.evaluate=function(t){for(var e=0;e<this.typeBinding.length;++e)t.setDynamicType(this.typeBinding[e].name.getText(),[]);return[t,!1,void 0,[]]},TypeDeclaration.prototype.prettyPrint=function(t,e){for(var n="type",i=0;i<this.typeBinding.length;++i)i>0&&(n+=" and"),n+=" <stuff> "+this.typeBinding[i].name.getText(),n+=" = "+this.typeBinding[i].type.prettyPrint();return n+";"},TypeDeclaration}(p);exports.TypeDeclaration=h;var l=function(t){function DatatypeDeclaration(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;if(o.position=e,o.datatypeBinding=n,o.typeBinding=i,o.id=r,void 0!==o.typeBinding)throw new s.FeatureDisabledError(o.position,'Don\'t use "withtype". It is evil.');return o}return n(DatatypeDeclaration,t),DatatypeDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.datatypeBinding.length;++e){for(var n=[],i=0;i<this.datatypeBinding[e].type.length;++i)void 0!==this.datatypeBinding[e].type[i][1]?n.push([this.datatypeBinding[e].type[i][0],this.datatypeBinding[e].type[i][1].simplify()]):n.push(this.datatypeBinding[e].type[i]);t.push(new C(this.datatypeBinding[e].position,this.datatypeBinding[e].typeVariableSequence,this.datatypeBinding[e].name,n))}return new DatatypeDeclaration(this.position,t,void 0,this.id)},DatatypeDeclaration.prototype.elaborate=function(t){return[t,[]]},DatatypeDeclaration.prototype.evaluate=function(t){for(var e=0;e<this.datatypeBinding.length;++e){for(var n=this.datatypeBinding[e].compute(t),i=0;i<n[0].length;++i){if(t.getRebindStatus(n[0][i][0])===a.RebindStatus.Never)throw new s.EvaluationError(this.position,'You simply cannot rebind "'+n[0][i][0]+'".');t.setDynamicValue(n[0][i][0],n[0][i][1],a.IdentifierStatus.VALUE_CONSTRUCTOR)}t.setDynamicType(n[1][0],n[1][1])}return[t,!1,void 0,[]]},DatatypeDeclaration.prototype.prettyPrint=function(t,e){for(var n="datatype",i=0;i<this.datatypeBinding.length;++i){i>0&&(n+=" and"),n+=" "+this.datatypeBinding[i].name.getText()+" =";for(var r=0;r<this.datatypeBinding[i].type.length;++r)r>0&&(n+=" | "),n+=" "+this.datatypeBinding[i].type[r][0].getText(),void 0!==this.datatypeBinding[i].type[r][1]&&(n+=" of "+this.datatypeBinding[i].type[r][1].prettyPrint())}return n},DatatypeDeclaration}(p);exports.DatatypeDeclaration=l;var f=function(t){function DatatypeReplication(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.name=n,o.oldname=i,o.id=r,o}return n(DatatypeReplication,t),DatatypeReplication.prototype.simplify=function(){return this},DatatypeReplication.prototype.elaborate=function(t){var e=t.getStaticType(this.oldname.getText());if(void 0===e)throw new s.ElaborationError(this.position,'The datatype "'+this.oldname.getText()+"\" doesn't exist.");return t.setStaticType(this.name.getText(),e.type,e.constructors),[t,[]]},DatatypeReplication.prototype.evaluate=function(t){var e=t.getDynamicType(this.oldname.getText());if(void 0===e)throw new s.EvaluationError(this.position,'The datatype "'+this.oldname.getText()+"\" doesn't exist.");return t.setDynamicType(this.name.getText(),e),[t,!1,void 0,[]]},DatatypeReplication.prototype.prettyPrint=function(t,e){return"datatype "+this.name.getText()+" = datatype "+this.oldname.getText()+";"},DatatypeReplication}(p);exports.DatatypeReplication=f;var d=function(t){function ExceptionDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.bindings=n,r.id=i,r}return n(ExceptionDeclaration,t),ExceptionDeclaration.prototype.simplify=function(){return this},ExceptionDeclaration.prototype.prettyPrint=function(t,e){throw new s.InternalInterpreterError(-1,"Not yet implemented.")},ExceptionDeclaration.prototype.elaborate=function(t){for(var e=0;e<this.bindings.length;++e)t=this.bindings[e].elaborate(t);return[t,[]]},ExceptionDeclaration.prototype.evaluate=function(t){for(var e=0;e<this.bindings.length;++e){var n=this.bindings[e].evaluate(t);if(n[1])return[n[0],n[1],n[2],[]];t=n[0]}return[t,!1,void 0,[]]},ExceptionDeclaration}(p);exports.ExceptionDeclaration=d;var y=function(t){function LocalDeclaration(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.declaration=n,o.body=i,o.id=r,o}return n(LocalDeclaration,t),LocalDeclaration.prototype.simplify=function(){return new LocalDeclaration(this.position,this.declaration.simplify(),this.body.simplify(),this.id)},LocalDeclaration.prototype.elaborate=function(t){var e=[t.getNestedState(t.id),[]],n=this.declaration.elaborate(e[0]),i=n[0].getNestedState(t.id);return e=this.body.elaborate(i),i.parent=t,[e[0],n[1].concat(e[1])]},LocalDeclaration.prototype.evaluate=function(t){var e=t.getNestedState(t.id),n=this.declaration.evaluate(e);if(n[1])return[t,!0,n[2],n[3]];e=n[0].getNestedState(t.id);var i=this.body.evaluate(e);return e.parent=t,i[3]=n[3].concat(i[3]),i},LocalDeclaration.prototype.prettyPrint=function(t,e){var n="local "+this.declaration.prettyPrint(t,e);return n+=" in "+this.body.prettyPrint(t,e),n+=" end;"},LocalDeclaration}(p);exports.LocalDeclaration=y;var v=function(t){function OpenDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.names=n,r.id=i,r}return n(OpenDeclaration,t),OpenDeclaration.prototype.simplify=function(){return this},OpenDeclaration.prototype.elaborate=function(t){throw new s.InternalInterpreterError(-1,"Yeah, you better wait a little before trying this again.")},OpenDeclaration.prototype.evaluate=function(t){throw new s.InternalInterpreterError(-1,"Yeah, you better wait a little before trying this again.")},OpenDeclaration.prototype.prettyPrint=function(t,e){for(var n="open",i=0;i<this.names.length;++i)n+=" "+this.names[i].getText();return n+";"},OpenDeclaration}(p);exports.OpenDeclaration=v;var w=function(t){function EmptyDeclaration(e){void 0===e&&(e=0);var n=t.call(this)||this;return n.id=e,n}return n(EmptyDeclaration,t),EmptyDeclaration.prototype.simplify=function(){return this},EmptyDeclaration.prototype.elaborate=function(t){return[t,[]]},EmptyDeclaration.prototype.evaluate=function(t){return[t,!1,void 0,[]]},EmptyDeclaration.prototype.prettyPrint=function(t,e){return" ;"},EmptyDeclaration}(p);exports.EmptyDeclaration=w;var T=function(t){function SequentialDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.declarations=n,r.id=i,r}return n(SequentialDeclaration,t),SequentialDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.declarations.length;++e)t.push(this.declarations[e].simplify());return new SequentialDeclaration(this.position,t,this.id)},SequentialDeclaration.prototype.elaborate=function(t){for(var e=[],n=0;n<this.declarations.length;++n){var i=this.declarations[n].elaborate(t.getNestedState(this.declarations[n].id));t=i[0],e=e.concat(i[1])}return[t,e]},SequentialDeclaration.prototype.evaluate=function(t){for(var e=[],n=0;n<this.declarations.length;++n){var i=t.getNestedState(this.declarations[n].id),r=this.declarations[n].evaluate(i);if(e=e.concat(r[3]),r[1])return[r[0],r[1],r[2],e];t=r[0]}return[t,!1,void 0,e]},SequentialDeclaration.prototype.prettyPrint=function(t,e){for(var n="",i=0;i<this.declarations.length;++i)i>0&&(n+=" "),n+=this.declarations[i].prettyPrint(t,e);return n},SequentialDeclaration}(p);exports.SequentialDeclaration=T;var m=function(t){function FunctionDeclaration(e,n,i,r){void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.typeVariableSequence=n,o.functionValueBinding=i,o.id=r,o}return n(FunctionDeclaration,t),FunctionDeclaration.prototype.simplify=function(){for(var t=[],e=0;e<this.functionValueBinding.length;++e)t.push(this.functionValueBinding[e].simplify());return new c(this.position,this.typeVariableSequence,t,this.id)},FunctionDeclaration}(p);exports.FunctionDeclaration=m;var g=function(t){function AbstypeDeclaration(e,n,i,r,o){void 0===o&&(o=0);var a=t.call(this)||this;if(a.position=e,a.datatypeBinding=n,a.typeBinding=i,a.declaration=r,a.id=o,void 0!==a.typeBinding)throw new s.FeatureDisabledError(a.position,'Don\'t use "withtype". It is evil.');return a}return n(AbstypeDeclaration,t),AbstypeDeclaration.prototype.simplify=function(){for(var t=new l(this.position,this.datatypeBinding,void 0,this.id),e=[],n=0;n<this.datatypeBinding.length;++n)e.push(new S(this.datatypeBinding[n].position,this.datatypeBinding[n].typeVariableSequence,this.datatypeBinding[n].name,new o.CustomType(this.datatypeBinding[n].name.getText(),this.datatypeBinding[n].typeVariableSequence)));var i=new h(this.position,e,this.id);return new y(this.position,t,new T(this.position,[i,this.declaration],this.id),this.id).simplify()},AbstypeDeclaration}(p);exports.AbstypeDeclaration=g;var E=function(t){function InfixDeclaration(e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.operators=n,o.precedence=i,o.id=r,o}return n(InfixDeclaration,t),InfixDeclaration.prototype.simplify=function(){return this},InfixDeclaration.prototype.elaborate=function(t){return[t,[]]},InfixDeclaration.prototype.evaluate=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],this.precedence,!1,!0);return[t,!1,void 0,[]]},InfixDeclaration.prototype.prettyPrint=function(t,e){var n="infix";n+=" "+this.precedence;for(var i=0;i<this.operators.length;++i)n+=" "+this.operators[i].getText();return n+";"},InfixDeclaration}(p);exports.InfixDeclaration=E;var I=function(t){function InfixRDeclaration(e,n,i,r){void 0===i&&(i=0),void 0===r&&(r=0);var o=t.call(this)||this;return o.position=e,o.operators=n,o.precedence=i,o.id=r,o}return n(InfixRDeclaration,t),InfixRDeclaration.prototype.simplify=function(){return this},InfixRDeclaration.prototype.elaborate=function(t){return[t,[]]},InfixRDeclaration.prototype.evaluate=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],this.precedence,!0,!0);return[t,!1,void 0,[]]},InfixRDeclaration.prototype.prettyPrint=function(t,e){var n="infixr";n+=" "+this.precedence;for(var i=0;i<this.operators.length;++i)n+=" "+this.operators[i].getText();return n+";"},InfixRDeclaration}(p);exports.InfixRDeclaration=I;var x=function(t){function NonfixDeclaration(e,n,i){void 0===i&&(i=0);var r=t.call(this)||this;return r.position=e,r.operators=n,r.id=i,r}return n(NonfixDeclaration,t),NonfixDeclaration.prototype.simplify=function(){return this},NonfixDeclaration.prototype.elaborate=function(t){return[t,[]]},NonfixDeclaration.prototype.evaluate=function(t){for(var e=0;e<this.operators.length;++e)t.setInfixStatus(this.operators[e],0,!1,!1);return[t,!1,void 0,[]]},NonfixDeclaration.prototype.prettyPrint=function(t,e){for(var n="nonfix",i=0;i<this.operators.length;++i)n+=" "+this.operators[i].getText();return n+";"},NonfixDeclaration}(p);exports.NonfixDeclaration=x;var k=function(){function ValueBinding(t,e,n,i){this.position=t,this.isRecursive=e,this.pattern=n,this.expression=i}return ValueBinding.prototype.prettyPrint=function(t,e){var n="";return this.isRecursive&&(n+="rec "),n+=this.pattern.prettyPrint(t,e),(n+=" = ")+this.expression.prettyPrint(t,e)},ValueBinding.prototype.compute=function(t){var e=this.expression.compute(t);return e[1]?[void 0,e[0],e[2],e[3]]:[this.pattern.matches(t,e[0]),void 0,e[2],e[3]]},ValueBinding}();exports.ValueBinding=k;var V=function(){function FunctionValueBinding(t,e,n){this.position=t,this.parameters=e,this.name=n}return FunctionValueBinding.prototype.simplify=function(){if(void 0===this.name)throw new s.InternalInterpreterError(this.position,"This function isn't ready to be simplified yet.");for(var t=[],e=[],n=0;n<this.parameters[0][0].length;++n)t.push(new i.ValueIdentifier(-1,new r.IdentifierToken("__arg"+n,-1)));for(var n=0;n<this.parameters.length;++n){var o=void 0;o=1===this.parameters[n][0].length?this.parameters[n][0][0]:new i.Tuple(-1,this.parameters[n][0]),void 0===this.parameters[n][1]?e.push([o,this.parameters[n][2]]):e.push([o,new i.TypedExpression(-1,this.parameters[n][2],this.parameters[n][1])])}var a;a=1!==t.length?new i.Tuple(-1,t).simplify():t[0];var u,p=new i.Match(-1,e);u=new i.CaseAnalysis(-1,a,p);for(var n=this.parameters[0][0].length-1;n>=0;--n)u=new i.Lambda(-1,new i.Match(-1,[[new i.ValueIdentifier(-1,new r.IdentifierToken("__arg"+n,-1)),u]]));return new k(this.position,!0,this.name,u.simplify())},FunctionValueBinding.prototype.prettyPrint=function(t,e){for(var n="",i=0;i<this.parameters.length;++i){i>0&&(n+=" | "),n+=this.name.name.getText();for(var r=0;r<this.parameters[i][0].length;++r)n+=" "+this.parameters[i][0][r].prettyPrint(t,e);void 0!==this.parameters[i][1]&&(n+=": "+this.parameters[i][1].prettyPrint()),n+=" = "+this.parameters[i][2].prettyPrint(t,e)}return n},FunctionValueBinding}();exports.FunctionValueBinding=V;var S=function(){function TypeBinding(t,e,n,i){this.position=t,this.typeVariableSequence=e,this.name=n,this.type=i}return TypeBinding}();exports.TypeBinding=S;var C=function(){function DatatypeBinding(t,e,n,i){this.position=t,this.typeVariableSequence=e,this.name=n,this.type=i}return DatatypeBinding.prototype.compute=function(t){for(var e=[],n=[],i=0;i<this.type.length;++i){var r=0;void 0!==this.type[i][1]&&(r=1);var o=t.getValueIdentifierId(this.type[i][0].getText());t.incrementValueIdentifierId(this.type[i][0].getText()),n.push([this.type[i][0].getText(),new u.ValueConstructor(this.type[i][0].getText(),r,o)]),e.push(this.type[i][0].getText())}return[n,[this.name.getText(),e]]},DatatypeBinding}();exports.DatatypeBinding=C;var R=function(){function DirectExceptionBinding(t,e,n){this.position=t,this.name=e,this.type=n}return DirectExceptionBinding.prototype.elaborate=function(t){if(void 0!==this.type){var e=[];if(this.type.getTypeVariables(!0).forEach(function(t){t.kill()instanceof o.TypeVariable&&e.push(t)}),e.length>0)throw s.ElaborationError.getUnguarded(this.position,e);t.setStaticValue(this.name.getText(),new o.FunctionType(this.type.simplify(),new o.CustomType("exn")),a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)}else t.setStaticValue(this.name.getText(),new o.CustomType("exn"),a.IdentifierStatus.EXCEPTION_CONSTRUCTOR);return t},DirectExceptionBinding.prototype.evaluate=function(t){var e=0;void 0!==this.type&&(e=1);var n=t.getValueIdentifierId(this.name.getText());if(t.incrementValueIdentifierId(this.name.getText()),t.getRebindStatus(this.name.getText())===a.RebindStatus.Never)throw new s.EvaluationError(this.position,'You simply cannot rebind "'+this.name.getText()+'".');return t.setDynamicValue(this.name.getText(),new u.ExceptionConstructor(this.name.getText(),e,n),a.IdentifierStatus.EXCEPTION_CONSTRUCTOR),[t,!1,void 0]},DirectExceptionBinding}();exports.DirectExceptionBinding=R;var L=function(){function ExceptionAlias(t,e,n){this.position=t,this.name=e,this.oldname=n}return ExceptionAlias.prototype.elaborate=function(t){var e=t.getStaticValue(this.oldname.getText());if(void 0===e)throw new s.ElaborationError(this.position,'Unbound value identifier "'+this.oldname.getText()+'".');if(e[1]!==a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)throw new s.ElaborationError(this.position,'You cannot transform "'+e[0].prettyPrint()+'" into an exception.');return t.setStaticValue(this.name.getText(),e[0],a.IdentifierStatus.EXCEPTION_CONSTRUCTOR),t},ExceptionAlias.prototype.evaluate=function(t){var e=t.getDynamicValue(this.oldname.getText());if(void 0===e)throw new s.EvaluationError(this.position,'Unbound value identifier "'+this.oldname.getText()+'".');if(e[1]!==a.IdentifierStatus.EXCEPTION_CONSTRUCTOR)throw new s.EvaluationError(this.position,'You cannot transform "'+e[0].prettyPrint(t)+'" into an exception.');return t.setDynamicValue(this.name.getText(),e[0],a.IdentifierStatus.EXCEPTION_CONSTRUCTOR),[t,!1,void 0]},ExceptionAlias}();exports.ExceptionAlias=L},function(t,exports,e){"use strict";var n=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};return function(e,n){function __(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(__.prototype=n.prototype,new __)}}();Object.defineProperty(exports,"__esModule",{value:!0});var i=e(3),r=e(6),o=e(1),a=e(2),s=e(0),u=e(4),p=e(5),c=function(){function Expression(){}return Expression.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,'Called "getType" on a derived form.')},Expression.prototype.compute=function(t){throw new s.InternalInterpreterError(this.position,'Called "getValue" on a derived form.')},Expression.prototype.prettyPrint=function(t,e){throw void 0===t&&(t=0),void 0===e&&(e=!0),new s.InternalInterpreterError(this.position,"I don't want to be printed.")},Expression}();exports.Expression=c;var h=function(t){function Constant(e,n){var i=t.call(this)||this;return i.position=e,i.token=n,i}return n(Constant,t),Constant.prototype.matches=function(t,e){return this.compute(t)[0].equals(e)?[]:void 0},Constant.prototype.getType=function(t){if(this.token instanceof o.IntegerConstantToken||this.token instanceof o.NumericToken)return[new i.CustomType("int")];if(this.token instanceof o.RealConstantToken)return[new i.CustomType("real")];if(this.token instanceof o.WordConstantToken)return[new i.CustomType("word")];if(this.token instanceof o.CharacterConstantToken)return[new i.CustomType("char")];if(this.token instanceof o.StringConstantToken)return[new i.CustomType("string")];throw new s.InternalInterpreterError(this.token.position,'"'+this.prettyPrint()+'" does not seem to be a valid constant.')},Constant.prototype.simplify=function(){return this},Constant.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),this.token.getText()},Constant.prototype.compute=function(t){if(this.token instanceof o.IntegerConstantToken||this.token instanceof o.NumericToken)return[new u.Integer(this.token.value),!1,[],[]];if(this.token instanceof o.RealConstantToken)return[new u.Real(this.token.value),!1,[],[]];if(this.token instanceof o.WordConstantToken)return[new u.Word(this.token.value),!1,[],[]];if(this.token instanceof o.CharacterConstantToken)return[new u.CharValue(this.token.value),!1,[],[]];if(this.token instanceof o.StringConstantToken)return[new u.StringValue(this.token.value),!1,[],[]];throw new s.EvaluationError(this.token.position,"You sure that this is a constant?")},Constant}(c);exports.Constant=h;var l=function(t){function ValueIdentifier(e,n){var i=t.call(this)||this;return i.position=e,i.name=n,i}return n(ValueIdentifier,t),ValueIdentifier.prototype.matches=function(t,e){var n=t.getDynamicValue(this.name.getText());return void 0===n||n[1]===a.IdentifierStatus.VALUE_VARIABLE?[[this.name.getText(),e]]:e.equals(n[0])?[]:void 0},ValueIdentifier.prototype.simplify=function(){return this},ValueIdentifier.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),this.name.getText()},ValueIdentifier.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,"nyi'an :3")},ValueIdentifier.prototype.compute=function(t){var e=t.getDynamicValue(this.name.getText());if(void 0===e)throw new s.EvaluationError(this.position,'Unbound value identifier "'+this.name.getText()+'".');return e[1]===a.IdentifierStatus.VALUE_CONSTRUCTOR&&0===e[0].numArgs?[e[0].construct(),!1,[],[]]:e[1]===a.IdentifierStatus.EXCEPTION_CONSTRUCTOR&&0===e[0].numArgs?[e[0].construct(),!1,[],[]]:[e[0],!1,[],[]]},ValueIdentifier}(c);exports.ValueIdentifier=l;var f=function(t){function Record(e,n,i){var r=t.call(this)||this;r.position=e,r.complete=n,r.entries=i,r.entries.sort();for(var o=1;o<r.entries.length;++o)if(r.entries[o][0]===r.entries[o-1][0])throw new s.ElaborationError(r.position,'Label "'+r.entries[o][0]+'" occurs more than once in the same record.');return r}return n(Record,t),Record.prototype.matches=function(t,e){if(e instanceof u.RecordValue&&(!this.complete||this.entries.length===e.entries.size)){for(var n=[],i=0;i<this.entries.length;++i){if(!e.hasValue(this.entries[i][0]))return;var r=this.entries[i][1].matches(t,e.getValue(this.entries[i][0]));if(void 0===r)return r;for(var o=0;o<r.length;++o)n.push(r[o])}return n}},Record.prototype.getType=function(t){throw new Error("nyian")},Record.prototype.simplify=function(){for(var t=[],e=0;e<this.entries.length;++e){var n=this.entries[e];t.push([n[0],n[1].simplify()])}return new Record(this.position,this.complete,t)},Record.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);for(var n="{",i=!0,r=0;r<this.entries.length;++r)i||(n+=", "),i=!1,n+=this.entries[r][0]+" = "+this.entries[r][1].prettyPrint(t,e);return this.complete||(i||(n+=", "),n+="..."),n+"}"},Record.prototype.compute=function(t){for(var e=new Map,n=[],i=[],r=0;r<this.entries.length;++r){var o=this.entries[r][1].compute(t);n=n.concat(o[2]),i=i.concat(o[3]);for(var a=0;a<o[3].length;++a)t.setCell(o[3][a][0],o[3][a][1]);if(o[1])return[o[0],!0,n,i];e=e.set(this.entries[r][0],o[0])}return[new u.RecordValue(e),!1,n,i]},Record}(c);exports.Record=f;var d=function(t){function LocalDeclarationExpression(e,n,i){var r=t.call(this)||this;return r.position=e,r.declaration=n,r.expression=i,r}return n(LocalDeclarationExpression,t),LocalDeclarationExpression.prototype.simplify=function(){return new LocalDeclarationExpression(this.position,this.declaration.simplify(),this.expression.simplify())},LocalDeclarationExpression.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);var n="let "+this.declaration.prettyPrint(t,e);return n+=" in "+this.expression.prettyPrint(t,e)+" end"},LocalDeclarationExpression.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,"nyi'an :3")},LocalDeclarationExpression.prototype.compute=function(t){var e=t.getNestedState(t.id),n=this.declaration.evaluate(e);if(n[1])return[n[2],!0,n[3],[]];var i=this.expression.compute(n[0]);return[i[0],i[1],n[3].concat(i[2]),i[3]]},LocalDeclarationExpression}(c);exports.LocalDeclarationExpression=d;var y=function(t){function TypedExpression(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.typeAnnotation=i,r}return n(TypedExpression,t),TypedExpression.prototype.matches=function(t,e){return this.expression.matches(t,e)},TypedExpression.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,"nyi'an :3")},TypedExpression.prototype.simplify=function(){return new TypedExpression(this.position,this.expression.simplify(),this.typeAnnotation.simplify())},TypedExpression.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);var n="( "+this.expression.prettyPrint(t,e);return(n+=": "+this.typeAnnotation.prettyPrint())+" )"},TypedExpression.prototype.compute=function(t){return this.expression.compute(t)},TypedExpression}(c);exports.TypedExpression=y;var v=function(t){function FunctionApplication(e,n,i){var r=t.call(this)||this;return r.position=e,r.func=n,r.argument=i,r}return n(FunctionApplication,t),FunctionApplication.prototype.matches=function(t,e){if(e instanceof u.FunctionValue)throw new s.EvaluationError(this.position,"You simply cannot match function values.");if(e instanceof u.ConstructedValue){if(this.func instanceof l&&this.func.name.getText()===e.constructorName&&"ref"!==this.func.name.getText())return void 0!==e.argument?this.argument.matches(t,e.argument):[]}else if(e instanceof u.ExceptionValue){if(this.func instanceof l&&this.func.name.getText()===e.constructorName)return void 0!==e.argument?this.argument.matches(t,e.argument):[]}else{if(e instanceof u.PredefinedFunction)throw new s.EvaluationError(this.position,"You simply cannot match predefined functions.");if(!(e instanceof u.ReferenceValue))throw new s.EvaluationError(this.position,"Help me, I'm broken. ("+e.constructor.name+").");if(this.func instanceof l&&"ref"===this.func.name.getText())return this.argument.matches(t,t.getCell(e.address))}},FunctionApplication.prototype.getType=function(t){throw new s.ElaborationError(this.func.position,this.func.prettyPrint()+" is not a function.")},FunctionApplication.prototype.simplify=function(){return new FunctionApplication(this.position,this.func.simplify(),this.argument.simplify())},FunctionApplication.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);var n="( "+this.func.prettyPrint(t,e);return(n+=" "+this.argument.prettyPrint(t,e))+" )"},FunctionApplication.prototype.compute=function(t){if(this.func instanceof l){if("ref"===this.func.name.getText()){var e=this.argument.compute(t);if(e[1])return[e[0],!0,e[2],e[3]];for(var n=0;n<e[3].length;++n)t.setCell(e[3][n][0],e[3][n][1]);var i=t.setNewCell(e[0]);return e[3].push([i.address,e[0]]),[i,!1,e[2],e[3]]}if(":="===this.func.name.getText()){var e=this.argument.compute(t);if(e[1])return[e[0],!0,e[2],e[3]];for(var n=0;n<e[3].length;++n)t.setCell(e[3][n][0],e[3][n][1]);if(!(e[0]instanceof u.RecordValue&&e[0].getValue("1")instanceof u.ReferenceValue))throw new s.EvaluationError(this.position,'That\'s not how ":=" works.');return e[3].push([e[0].getValue("1").address,e[0].getValue("2")]),[new u.RecordValue,!1,e[2],e[3]]}if("!"===this.func.name.getText()){var e=this.argument.compute(t);if(e[1])return[e[0],!0,e[2],e[3]];for(var n=0;n<e[3].length;++n)t.setCell(e[3][n][0],e[3][n][1]);if(!(e[0]instanceof u.ReferenceValue))throw new s.EvaluationError(this.position,'You cannot dereference "'+this.argument.prettyPrint()+'".');return[t.getCell(e[0].address),!1,e[2],e[3]]}}var r=this.func.compute(t);if(r[1])return r;for(var n=0;n<r[3].length;++n)t.setCell(r[3][n][0],r[3][n][1]);var o=this.argument.compute(t),a=r[2].concat(o[2]),p=r[3].concat(o[3]);if(o[1])return[o[0],!0,a,p];if(r[0]instanceof u.FunctionValue){for(var n=0;n<o[3].length;++n)t.setCell(o[3][n][0],o[3][n][1]);for(var c=[],n=0;n<t.memory[0];++n)void 0!==t.getCell(n)&&c.push([n,t.getCell(n)]);var i=r[0].compute(o[0],c);return[i[0],i[1],a.concat(i[2]),p.concat(i[3])]}if(r[0]instanceof u.ValueConstructor)return[r[0].construct(o[0]),!1,a,p];if(r[0]instanceof u.ExceptionConstructor)return[r[0].construct(o[0]),!1,a,p];if(r[0]instanceof u.PredefinedFunction){var i=r[0].apply(o[0]);return[i[0],i[1],a.concat(i[2]),p]}throw new s.EvaluationError(this.position,'Cannot evaluate the function "'+this.func.prettyPrint()+'" ('+r[0].constructor.name+").")},FunctionApplication}(c);exports.FunctionApplication=v;var w=function(t){function HandleException(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.match=i,r}return n(HandleException,t),HandleException.prototype.simplify=function(){return new HandleException(this.position,this.expression.simplify(),this.match.simplify())},HandleException.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);var n="( ( "+this.expression.prettyPrint(t,e)+" )";return n+=" handle "+this.match.prettyPrint(t,e)+" )"},HandleException.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,"nyi'an :3")},HandleException.prototype.compute=function(t){var e=this.expression.compute(t);if(e[1]){for(var n=0;n<e[3].length;++n)t.setCell(e[3][n][0],e[3][n][1]);var i=this.match.compute(t,e[0]);if(!i[1]||!i[0].equals(new u.ExceptionValue("Match",void 0,0)))return[i[0],i[1],e[2].concat(i[2]),e[3].concat(i[3])];e[2]=e[2].concat(i[2]),e[3]=e[3].concat(i[3])}return e},HandleException}(c);exports.HandleException=w;var T=function(t){function RaiseException(e,n){var i=t.call(this)||this;return i.position=e,i.expression=n,i}return n(RaiseException,t),RaiseException.prototype.simplify=function(){return new RaiseException(this.position,this.expression.simplify())},RaiseException.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),"raise "+this.expression.prettyPrint(t,e)},RaiseException.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,"nyi'an :3")},RaiseException.prototype.compute=function(t){var e=this.expression.compute(t);if(!(e[0]instanceof u.ExceptionValue))throw new s.EvaluationError(this.position,'Cannot "raise" value of type "'+e.constructor.name+'" (type must be "exn").');return[e[0],!0,e[2],e[3]]},RaiseException}(c);exports.RaiseException=T;var m=function(t){function Lambda(e,n){var i=t.call(this)||this;return i.position=e,i.match=n,i}return n(Lambda,t),Lambda.prototype.simplify=function(){return new Lambda(this.position,this.match.simplify())},Lambda.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),"( fn "+this.match.prettyPrint(t,e)+" )"},Lambda.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,"nyi'an :3")},Lambda.prototype.compute=function(t){var e=p.getInitialState().getNestedState(t.id);return t.getDefinedIdentifiers().forEach(function(n){var i=t.getDynamicValue(n),r=t.getDynamicType(n);void 0!==i&&e.setDynamicValue(n,i[0],i[1]),void 0!==r&&e.setDynamicType(n,r)}),[new u.FunctionValue(e,[],this.match),!1,[],[]]},Lambda}(c);exports.Lambda=m;var g=function(){function Match(t,e){this.position=t,this.matches=e}return Match.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);for(var n="",i=0;i<this.matches.length;++i)i>0&&(n+=" | "),n+=this.matches[i][0].prettyPrint(t,e),n+=" => "+this.matches[i][1].prettyPrint(t,e);return n},Match.prototype.compute=function(t,e){for(var n=0;n<this.matches.length;++n){var i=t.getNestedState(t.id),r=this.matches[n][0].matches(i,e);if(void 0!==r){for(var o=0;o<r.length;++o)i.setDynamicValue(r[o][0],r[o][1],a.IdentifierStatus.VALUE_VARIABLE);return this.matches[n][1].compute(i)}}return[new u.ExceptionValue("Match",void 0,0),!0,[],[]]},Match.prototype.getType=function(t){throw new s.InternalInterpreterError(this.position,"nyi'an :3")},Match.prototype.simplify=function(){for(var t=[],e=0;e<this.matches.length;++e){var n=this.matches[e];t.push([n[0].simplify(),n[1].simplify()])}return new Match(this.position,t)},Match}();exports.Match=g;var E=function(t){function Wildcard(e){var n=t.call(this)||this;return n.position=e,n}return n(Wildcard,t),Wildcard.prototype.getType=function(t){return[new i.TypeVariable("''__wc"),new i.TypeVariable("'__wc")]},Wildcard.prototype.compute=function(t){throw new s.InternalInterpreterError(this.position,"Wildcards are far too wild to have a value.")},Wildcard.prototype.matches=function(t,e){return[]},Wildcard.prototype.simplify=function(){return this},Wildcard.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),"_"},Wildcard}(c);exports.Wildcard=E;var I=function(t){function LayeredPattern(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.identifier=n,o.typeAnnotation=i,o.pattern=r,o}return n(LayeredPattern,t),LayeredPattern.prototype.compute=function(t){throw new s.InternalInterpreterError(this.position,"Layered patterns are far too layered to have a value.")},LayeredPattern.prototype.getType=function(t){throw new Error("nyian")},LayeredPattern.prototype.matches=function(t,e){var n=this.pattern.matches(t,e);if(void 0===n)return n;for(var i=[[this.identifier.getText(),e]],r=0;r<n.length;++r)i.push(n[r]);return i},LayeredPattern.prototype.simplify=function(){return this.typeAnnotation?new LayeredPattern(this.position,this.identifier,this.typeAnnotation.simplify(),this.pattern.simplify()):new LayeredPattern(this.position,this.identifier,void 0,this.pattern.simplify())},LayeredPattern.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),this.identifier.getText()+" as "+this.pattern.prettyPrint(t,e)},LayeredPattern}(c);exports.LayeredPattern=I;var x=function(t){function InfixExpression(e,n){var i=t.call(this)||this;return i.expressions=e,i.operators=n,i}return n(InfixExpression,t),InfixExpression.prototype.matches=function(t,e){return this.reParse(t).matches(t,e)},InfixExpression.prototype.simplify=function(){throw new s.InternalInterpreterError(this.position,"Ouch, I'm not fully parsed.")},InfixExpression.prototype.reParse=function(t){for(var e=this.operators,n=this.expressions,i=[],r=0;r<n.length;++r)i.push([r]);e.sort(function(e,n){var i=e[0],r=e[1],o=n[0],a=n[1],s=t.getInfixStatus(i),u=t.getInfixStatus(o);if(s.precedence>u.precedence)return-1;if(s.precedence<u.precedence)return 1;if(s.rightAssociative){if(r>a)return-1;if(r<a)return 1}else{if(r>a)return 1;if(r<a)return-1}return 0});for(var r=0;r<e.length;++r){if(r>0){var o=t.getInfixStatus(e[r][0]),a=t.getInfixStatus(e[r-1][0]);if(o.precedence===a.precedence&&o.rightAssociative!==a.rightAssociative&&(i[e[r-1][1]+1]===i[e[r][1]]||i[e[r-1][1]]===i[e[r][1]+1]))throw new s.ParserError("Could you ever imagine left associatives and right associatives living together in peace?",e[r][0].position)}for(var u=n[e[r][1]],p=n[e[r][1]+1],c=new v(e[r][0].position,new l(e[r][0].position,e[r][0]),new A(e[r][0].position,[u,p])),h=i[e[r][1]],f=0,d=i[e[r][1]+1];f<d.length;f++){var y=d[f];h.push(y)}for(var w=0,T=h;w<T.length;w++){var y=T[w];i[y]=h,n[y]=c}}return n[0]},InfixExpression}(c);exports.InfixExpression=x;var k=new l(0,new o.IdentifierToken("false",0)),V=new l(0,new o.IdentifierToken("true",0)),S=new l(0,new o.IdentifierToken("nil",0)),C=new l(0,new o.IdentifierToken("::",0)),R=function(t){function Conjunction(e,n,i){var r=t.call(this)||this;return r.position=e,r.leftOperand=n,r.rightOperand=i,r}return n(Conjunction,t),Conjunction.prototype.simplify=function(){return new B(this.position,this.leftOperand,this.rightOperand,k).simplify()},Conjunction.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),"( "+this.leftOperand.prettyPrint(t,e)+" andalso "+this.rightOperand.prettyPrint(t,e)+" )"},Conjunction}(c);exports.Conjunction=R;var L=function(t){function Disjunction(e,n,i){var r=t.call(this)||this;return r.position=e,r.leftOperand=n,r.rightOperand=i,r}return n(Disjunction,t),Disjunction.prototype.simplify=function(){return new B(this.position,this.leftOperand,V,this.rightOperand).simplify()},Disjunction.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),"( "+this.leftOperand.prettyPrint(t,e)+" orelse "+this.rightOperand.prettyPrint(t,e)+" )"},Disjunction}(c);exports.Disjunction=L;var A=function(t){function Tuple(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return n(Tuple,t),Tuple.prototype.matches=function(t,e){return this.simplify().matches(t,e)},Tuple.prototype.simplify=function(){for(var t=[],e=0;e<this.expressions.length;++e)t.push([""+(e+1),this.expressions[e].simplify()]);return new f(this.position,!0,t)},Tuple.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);for(var n="( ",i=0;i<this.expressions.length;++i)i>0&&(n+=", "),n+=this.expressions[i].prettyPrint(t,e);return n+" )"},Tuple}(c);exports.Tuple=A;var b=function(t){function List(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return n(List,t),List.prototype.matches=function(t,e){return this.simplify().matches(t,e)},List.prototype.simplify=function(){for(var t=S,e=this.expressions.length-1;e>=0;--e){var n=new A(-1,[this.expressions[e],t]).simplify();t=new v(-1,C,n)}return t},List.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);for(var n="[ ",i=0;i<this.expressions.length;++i)i>0&&(n+=", "),n+=this.expressions[i].prettyPrint(t,e);return n+" ]"},List}(c);exports.List=b;var P=function(t){function Sequence(e,n){var i=t.call(this)||this;return i.position=e,i.expressions=n,i}return n(Sequence,t),Sequence.prototype.simplify=function(){for(var t=this.expressions.length-1,e=new g(-1,[[new E(0),this.expressions[t]]]),n=new D(-1,this.expressions[t-1],e),i=t-2;i>=0;--i)e=new g(-1,[[new E(0),n]]),n=new D(-1,this.expressions[i],e);return n.simplify()},Sequence.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);for(var n="( ",i=0;i<this.expressions.length;++i)i>0&&(n+="; "),n+=this.expressions[i].prettyPrint(t,e);return n+" )"},Sequence}(c);exports.Sequence=P;var _=function(t){function RecordSelector(e,n){var i=t.call(this)||this;return i.position=e,i.label=n,i}return n(RecordSelector,t),RecordSelector.prototype.simplify=function(){return new m(this.position,new g(-1,[[new f(-1,!1,[[this.label.text,new l(-1,new o.IdentifierToken("__rs",-1))]]),new l(-1,new o.IdentifierToken("__rs",-1))]]))},RecordSelector.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),"#"+this.label.getText()},RecordSelector}(c);exports.RecordSelector=_;var D=function(t){function CaseAnalysis(e,n,i){var r=t.call(this)||this;return r.position=e,r.expression=n,r.match=i,r}return n(CaseAnalysis,t),CaseAnalysis.prototype.simplify=function(){return new v(this.position,new m(this.position,this.match.simplify()),this.expression.simplify())},CaseAnalysis.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);var n="case "+this.expression.prettyPrint(t,e);return n+=" of "+this.match.prettyPrint(t,e)},CaseAnalysis}(c);exports.CaseAnalysis=D;var B=function(t){function Conditional(e,n,i,r){var o=t.call(this)||this;return o.position=e,o.condition=n,o.consequence=i,o.alternative=r,o}return n(Conditional,t),Conditional.prototype.simplify=function(){var t=new g(this.position,[[V,this.consequence],[k,this.alternative]]);return new D(this.position,this.condition,t).simplify()},Conditional.prototype.prettyPrint=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0);var n="if "+this.condition.prettyPrint(t,e);return n+=" then "+this.consequence.prettyPrint(t,e),n+=" else "+this.alternative.prettyPrint(t,e)},Conditional}(c);exports.Conditional=B;var O=function(t){function While(e,n,i){var r=t.call(this)||this;return r.position=e,r.condition=n,r.body=i,r}return n(While,t),While.prototype.simplify=function(){var t=new l(this.position,new o.IdentifierToken("__whl",this.position)),e=new v(this.position,t,new A(this.position,[])),n=new B(this.position,this.condition,new P(this.position,[this.body,e]),new A(this.position,[])),i=new r.ValueBinding(this.position,!0,t,new m(this.position,new g(this.position,[[new A(this.position,[]),n]]))),a=new r.ValueDeclaration(this.position,[],[i]);return new d(this.position,a,e).simplify()},While.prototype.prettyPrint=function(t,e){return void 0===t&&(t=0),void 0===e&&(e=!0),"( while "+this.condition.prettyPrint(t,e)+" do "+this.body.prettyPrint(t,e)+" )"},While}(c);exports.While=O},function(t,exports,e){"use strict";function interpret(t,e,i){void 0===e&&(e=n.getInitialState()),void 0===i&&(i={allowLongFunctionNames:!1,allowUnicodeInStrings:!1});var s=e.getNestedState(),u=o.lex(t,i);if(i.allowLongFunctionNames){for(var p=[],c=0,h=u;c<h.length;c++){var l=h[c];l instanceof r.LongIdentifierToken?p.push(new r.IdentifierToken(l.getText(),l.position)):p.push(l)}u=p}var f=a.parse(u,s,i);s=e.getNestedState(),f=f.simplify();var d=f.elaborate(s);s=d[0];for(var y=f.evaluate(e.getNestedState()),v=0;v<d[1].length;++v)y[3].push(d[1][v]);if(y[1])return{state:y[0],evaluationErrored:!0,error:y[2],warnings:y[3]};for(var w=y[0];w.id>e.id;){if(void 0!==w.dynamicBasis){for(var v in w.dynamicBasis.valueEnvironment)if(Object.prototype.hasOwnProperty.call(w.dynamicBasis.valueEnvironment,v)){var T=s.getStaticValue(v,w.id);void 0!==T&&w.setStaticValue(v,T[0],T[1])}for(var v in w.dynamicBasis.typeEnvironment)if(Object.prototype.hasOwnProperty.call(w.dynamicBasis.typeEnvironment,v)){var T=s.getStaticType(v,w.id);void 0!==T&&w.setStaticType(v,T.type,T.constructors)}}if(void 0===s.parent)break;for(w=w.parent;s.id>w.id&&void 0!==s.parent;)s=s.parent}return{state:y[0],evaluationErrored:!1,error:y[2],warnings:y[3]}}function getFirstState(t){return t?i.addStdLib(n.getInitialState(),{allowLongFunctionNames:!0}):n.getInitialState()}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(5),i=e(11),r=e(1),o=e(9),a=e(10);exports.interpret=interpret,exports.getFirstState=getFirstState},function(t,exports,e){"use strict";function lex(t,e){for(var n=new a(t,e),i=[];!n.finished();)i.push(n.nextToken());return i}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(0),i=e(1),r=new Set(["abstype","and","andalso","as","case","datatype","do","else","end","exception","fn","fun","handle","if","in","infix","infixr","let","local","nonfix","of","op","open","orelse","raise","rec","then","type","val","with","withtype","while","(",")","[","]","{","}",",",":",";","...","_","|","=","=>","->","#","eqtype","functor","signature","struct","include","sharing","structure","where","sig",":>"]),o=new Set(["!","%","&","$","#","+","-","/",":","<","=",">","?","@","\\","~","`","^","|","*"]),a=function(){function Lexer(t,e){this.input=t,this.options=e,this.position=0,this.skipWhitespaceAndComments()}return Lexer.isAlphanumeric=function(t){return t>="a"&&t<="z"||t>="A"&&t<="Z"||t>="0"&&t<="9"||"'"===t||"_"===t},Lexer.isSymbolic=function(t){return o.has(t)},Lexer.isWhitespace=function(t){return" "===t||"\t"===t||"\n"===t||"\f"===t},Lexer.isNumber=function(t,e){return t>="0"&&t<="9"||e&&(t>="a"&&t<="f"||t>="A"&&t<="F")},Lexer.prototype.consumeChar=function(t,e){if(void 0===t&&(t=""),void 0===e&&(e=this.input.length-1),this.position>=this.input.length)throw""===t?new n.IncompleteError(e):new n.IncompleteError(e,t);return++this.position,this.input.charAt(this.position-1)},Lexer.prototype.getChar=function(t){return void 0===t&&(t=0),this.position+t>=this.input.length?"":this.input.charAt(this.position+t)},Lexer.prototype.skipWhitespace=function(){for(;Lexer.isWhitespace(this.getChar());)++this.position},Lexer.prototype.skipWhitespaceAndComments=function(){var t;do{for(t=this.position,this.skipWhitespace();this.position+1<this.input.length&&"(*"===this.input.substr(this.position,2);){var e=this.position;this.position+=2;for(var i=1;i>0;){if(this.position>this.input.length-2)throw new n.IncompleteError(e,"unclosed comment");var r=this.input.substr(this.position,2);"(*"===r?(++i,++this.position):"*)"===r&&(--i,++this.position),++this.position}}}while(this.position!==t);this.tokenStart=this.position},Lexer.prototype.readNumeric=function(t,e){void 0===e&&(e=-1);for(var n="";Lexer.isNumber(this.getChar(),t)&&n.length!==e;)n+=this.consumeChar();return n},Lexer.prototype.makeNumberToken=function(t,e,r,o){if(void 0===e&&(e=!1),void 0===r&&(r=!1),void 0===o&&(o=!1),e&&r)throw new n.InternalInterpreterError(this.position);var a=this.input.substring(this.tokenStart,this.position);if(e)return new i.RealConstantToken(a,this.tokenStart,parseFloat(t));var s=parseInt(t,o?16:10);if(r)return new i.WordConstantToken(a,this.tokenStart,s);var u=a.charAt(0);return Lexer.isNumber(u,!1)&&"0"!==u?new i.NumericToken(a,this.tokenStart,s):new i.IntegerConstantToken(a,this.tokenStart,s)},Lexer.prototype.lexNumber=function(){var t="",e=!1,n=!1,i=!1,r=!1;if("~"===this.getChar()&&(++this.position,r=!0,t+="-"),"0"===this.getChar()&&("w"===this.getChar(1)||"x"===this.getChar(1))){++this.position,"w"===this.getChar()&&(n=!0),"x"===this.getChar(n?1:0)&&(e=!0);var o=n&&e?2:1;if(r&&n||!Lexer.isNumber(this.getChar(o),e))return t+="0",this.makeNumberToken(t,!1,!1,!1);this.position+=o}if(t+=this.readNumeric(e),e||n)return this.makeNumberToken(t,!1,n,e);if("."===this.getChar()){if(!Lexer.isNumber(this.getChar(1),!1))return this.makeNumberToken(t);t+=this.consumeChar(),t+=this.readNumeric(!1),i=!0}if("e"===this.getChar()||"E"===this.getChar()){if(Lexer.isNumber(this.getChar(1),!1))t+="e",++this.position,t+=this.readNumeric(!1);else{if("~"!==this.getChar(1)||!Lexer.isNumber(this.getChar(2),!1))return this.makeNumberToken(t,i);t+="e-",this.position+=2,t+=this.readNumeric(!1)}i=!0}return this.makeNumberToken(t,i)},Lexer.prototype.lexString=function(){var t=this.position;if('"'!==this.consumeChar())throw new n.InternalInterpreterError(this.position);for(var e="";'"'!==this.getChar();)if("\\"===this.getChar())if(++this.position,Lexer.isWhitespace(this.getChar())){if(this.skipWhitespace(),"\\"!==this.consumeChar("unterminated whitespace escape sequence"))throw new n.LexerError(this.position-1,"only whitespace is allowed in whitespace escape sequence")}else{var r=this.consumeChar();switch(r){case"a":e+="";break;case"b":e+="\b";break;case"t":e+="\t";break;case"n":e+="\n";break;case"v":e+="\v";break;case"f":e+="\f";break;case"r":e+="\r";break;case'"':e+='"';break;case"\\":e+="\\";break;case"^":var o=this.consumeChar().charCodeAt(0);if(o<64||o>95)throw new n.LexerError(this.position-1,'"'+String.fromCharCode(o)+'" does not represent a valid control character');e+=String.fromCharCode(o-64);break;case"u":var a=this.readNumeric(!0,4);if(4!==a.length)throw new n.LexerError(this.position-a.length-1,"unicode escape sequence must have four digits");var s=parseInt(a,16);if(s>=256&&!this.options.allowUnicodeInStrings)throw new n.LexerError(this.position-a.length-1,"character code "+a+" is too large, only 00 to ff is allowed");e+=String.fromCharCode(s);break;default:if(!Lexer.isNumber(r,!1))throw new n.LexerError(this.position-1,"invalid escape sequence");--this.position;var a=this.readNumeric(!1,3);if(3!==a.length)throw new n.LexerError(this.position-a.length-1,"numeric escape sequence must have three digits");var s=parseInt(a,10);if(s>=256&&!this.options.allowUnicodeInStrings)throw new n.LexerError(this.position-a.length-1,"character code "+a+" is too large, only 000 to 255 is allowed");e+=String.fromCharCode(s)}}else{var r=this.consumeChar("unterminated string",this.tokenStart).charCodeAt(0);if((r<33||r>126)&&32!==r&&r<128)throw new n.LexerError(this.position-1,"invalid character with code "+r+" in string");e+=String.fromCharCode(r)}if('"'!==this.consumeChar())throw new n.InternalInterpreterError(this.position);return new i.StringConstantToken(this.input.substring(t,this.position),this.tokenStart,e)},Lexer.prototype.lexCharacter=function(){if("#"!==this.consumeChar())throw new n.InternalInterpreterError(this.position);var t=this.lexString();if(1!==t.value.length)throw new n.LexerError(this.tokenStart,"character constant must have length 1, not "+t.value.length);return new i.CharacterConstantToken("#"+t.text,this.tokenStart,t.value)},Lexer.prototype.lexIdentifierOrKeyword=function(){var t,e="",o=this.getChar();if(Lexer.isSymbolic(o))t=Lexer.isSymbolic;else{if(!Lexer.isAlphanumeric(o)||Lexer.isNumber(o,!1)||"_"===o){if(r.has(o))return new i.KeywordToken(this.consumeChar(),this.tokenStart);if("."===o&&"."===this.getChar(1)&&"."===this.getChar(2))return this.position+=3,new i.KeywordToken("...",this.tokenStart);throw o.charCodeAt(0)<32?new n.LexerError(this.position,"invalid character with ascii code "+o.charCodeAt(0)):new n.LexerError(this.position,"invalid token: "+o)}t=Lexer.isAlphanumeric}do{e+=this.consumeChar()}while(t(this.getChar()));return"*"===e?new i.StarToken(this.tokenStart):"="===e?new i.EqualsToken(this.tokenStart):r.has(e)?new i.KeywordToken(e,this.tokenStart):"'"===o?"'"===e.charAt(1)?new i.EqualityTypeVariableToken(e,this.tokenStart):new i.TypeVariableToken(e,this.tokenStart):Lexer.isAlphanumeric(o)?new i.AlphanumericIdentifierToken(e,this.tokenStart):new i.IdentifierToken(e,this.tokenStart)},Lexer.prototype.lexLongIdentifierOrKeyword=function(){var t=this.tokenStart,e=this.lexIdentifierOrKeyword();if("."!==this.getChar())return e;var r=[];do{if(this.consumeChar(),!(e instanceof i.AlphanumericIdentifierToken))throw new n.LexerError(e.position,'expected structure name before "."');r.push(e),this.tokenStart=this.position,e=this.lexIdentifierOrKeyword()}while("."===this.getChar());if(!(e instanceof i.IdentifierToken||e instanceof i.StarToken)||e instanceof i.TypeVariableToken)throw new n.LexerError(e.position,e.text+" is not allowed in a long identifier");return new i.LongIdentifierToken(this.input.substring(t,this.position),t,r,e)},Lexer.prototype.nextToken=function(){var t;return this.tokenStart=this.position,t=Lexer.isNumber(this.getChar(),!1)||"~"===this.getChar()&&Lexer.isNumber(this.getChar(1),!1)?this.lexNumber():'"'===this.getChar()?this.lexString():"#"===this.getChar()&&'"'===this.getChar(1)?this.lexCharacter():this.lexLongIdentifierOrKeyword(),this.skipWhitespaceAndComments(),t},Lexer.prototype.finished=function(){return this.position>=this.input.length},Lexer}();exports.lex=lex},function(t,exports,e){"use strict";function parse(t,e,n){return new s(t,e,e.id,n).parseDeclaration(!0)}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(7),i=e(3),r=e(0),o=e(1),a=e(6),s=function(){function Parser(t,e,n,i){if(this.tokens=t,this.state=e,this.currentId=n,this.position=0,void 0===this.state)throw new r.InternalInterpreterError(-1,"What are you, stupid? Hurry up and give me a state already!")}return Parser.prototype.assertKeywordToken=function(t,e){if(void 0===e&&(e=void 0),!(t instanceof o.KeywordToken))throw new r.ParserError('Expected a reserved word, got "'+t.getText()+'" ('+t.constructor.name+").",t.position);if(void 0!==e&&t.text!==e)throw new r.ParserError('Expected "'+e+'" but got "'+t.text+'".',t.position)},Parser.prototype.assertVidToken=function(t){if(!t.isVid())throw new r.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},Parser.prototype.assertIdentifierToken=function(t){if(!(t instanceof o.IdentifierToken))throw new r.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},Parser.prototype.assertVidOrLongToken=function(t){if(!(t.isVid()||t instanceof o.LongIdentifierToken))throw new r.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},Parser.prototype.assertIdentifierOrLongToken=function(t){if(!(t instanceof o.IdentifierToken||t instanceof o.LongIdentifierToken))throw new r.ParserError('Expected an identifier, got "'+t.getText()+'" ('+t.constructor.name+").",t.position)},Parser.prototype.assertRecordLabelToken=function(t){if(!t.isValidRecordLabel())throw new r.ParserError('Expected a record label "'+t.getText()+'" ('+t.constructor.name+").",t.position)},Parser.prototype.checkVidOrLongToken=function(t){return t.isVid()||t instanceof o.LongIdentifierToken},Parser.prototype.checkIdentifierOrLongToken=function(t){return t instanceof o.IdentifierToken||t instanceof o.LongIdentifierToken},Parser.prototype.checkKeywordToken=function(t,e){return void 0===e&&(e=void 0),t instanceof o.KeywordToken&&(void 0===e||t.text===e)},Parser.prototype.parseOpIdentifierToken=function(t){void 0===t&&(t=!1);var e=this.currentToken(),n=this.checkKeywordToken(e,"op");n&&++this.position,t?this.assertIdentifierOrLongToken(this.currentToken()):this.assertIdentifierToken(this.currentToken());var i=this.currentToken();return i.opPrefixed=n,++this.position,i},Parser.prototype.parseAtomicExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"op")){++this.position;var e=this.currentToken();return this.assertVidOrLongToken(e),e.opPrefixed=!0,++this.position,new n.ValueIdentifier(t.position,e)}if(this.checkKeywordToken(t,"{"))return++this.position,this.parseExpressionRow();if(this.checkKeywordToken(t,"(")){if(++this.position,this.checkKeywordToken(this.currentToken(),")"))return++this.position,new n.Tuple(t.position,[]);for(var i=[this.parseExpression()],a=!1,s=!1;;){var e=this.currentToken();if(this.checkKeywordToken(e,",")&&!a)++this.position,s=!0;else if(this.checkKeywordToken(e,";")&&!s)++this.position,a=!0;else{if(!this.checkKeywordToken(e,")"))throw new r.ParserError('Expected ",", ";" or ")" but got "'+e.getText()+'".',e.position);if(++this.position,1===i.length)return i[0];if(s)return new n.Tuple(t.position,i);if(a)return new n.Sequence(t.position,i)}i.push(this.parseExpression())}}if(this.checkKeywordToken(t,"[")){if(++this.position,this.checkKeywordToken(this.currentToken(),"]"))return++this.position,new n.List(t.position,[]);for(var i=[this.parseExpression()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,"]"))return++this.position,new n.List(t.position,i);throw new r.ParserError('Expected "," or "]" but found "'+e.getText()+'".',e.position)}++this.position,i.push(this.parseExpression())}}if(this.checkKeywordToken(t,"#")){++this.position;var u=this.currentToken();return this.assertRecordLabelToken(u),++this.position,new n.RecordSelector(t.position,u)}if(this.checkKeywordToken(t,"let")){++this.position;var p=this.state;this.state=this.state.getNestedState(this.state.id);var c=this.parseDeclaration();this.assertKeywordToken(this.currentToken(),"in"),++this.position;for(var h=[this.parseExpression()],l=this.currentToken(),f=l.position;this.checkKeywordToken(l,";");)++this.position,h.push(this.parseExpression()),l=this.currentToken();return this.assertKeywordToken(l,"end"),++this.position,this.state=p,h.length>=2?new n.LocalDeclarationExpression(t.position,c,new n.Sequence(f,h)):new n.LocalDeclarationExpression(t.position,c,h[0])}if(t instanceof o.ConstantToken)return++this.position,new n.Constant(t.position,t);if(t.isVid()||t instanceof o.LongIdentifierToken){if(++this.position,void 0!==this.state.getInfixStatus(t)&&this.state.getInfixStatus(t).infix)throw new r.ParserError('Infix operator "'+t.getText()+'" appeared in non-infix context without "op".',t.position);return new n.ValueIdentifier(t.position,t)}throw new r.ParserError('Expected atomic expression, "'+t.getText()+'" found.',t.position)},Parser.prototype.parseExpressionRow=function(){for(var t=this.currentToken(),e=[],i=!0;;){var o=this.currentToken();if(this.checkKeywordToken(o,"}"))return++this.position,new n.Record(t.position,!0,e);if(i||!this.checkKeywordToken(o,",")){if(i=!1,!o.isValidRecordLabel())throw new r.ParserError('Expected "}", or identifier, got "'+o.getText()+'".',o.position);++this.position;var a=this.currentToken();this.assertKeywordToken(a,"="),++this.position,e.push([o.getText(),this.parseExpression()])}else++this.position}},Parser.prototype.parseApplicationExpression=function(){for(var t=this.currentToken(),e=this.parseAtomicExpression();;){var i=this.position,r=this.currentToken();if(this.checkVidOrLongToken(r)&&void 0!==this.state.getInfixStatus(r)&&this.state.getInfixStatus(r).infix)break;try{var o=this.parseAtomicExpression();e=new n.FunctionApplication(t.position,e,o)}catch(t){this.position=i;break}}return e},Parser.prototype.parseInfixExpression=function(){for(var t=[],e=[],i=0;;){t.push(this.parseApplicationExpression());var r=this.currentToken();if(!this.checkVidOrLongToken(r)||void 0===this.state.getInfixStatus(r)||!this.state.getInfixStatus(r).infix)break;++this.position,e.push([r,i++])}return 0===i?t[0]:new n.InfixExpression(t,e).reParse(this.state)},Parser.prototype.parseAppendedExpression=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"raise"))return++this.position,new n.RaiseException(t.position,this.parseExpression());if(this.checkKeywordToken(t,"if")){++this.position;var e=this.parseExpression();this.assertKeywordToken(this.currentToken(),"then"),++this.position;var i=this.parseExpression();return this.assertKeywordToken(this.currentToken(),"else"),++this.position,new n.Conditional(t.position,e,i,this.parseExpression())}if(this.checkKeywordToken(t,"case")){++this.position;var e=this.parseExpression();return this.assertKeywordToken(this.currentToken(),"of"),++this.position,new n.CaseAnalysis(t.position,e,this.parseMatch())}if(this.checkKeywordToken(t,"while")){++this.position;var e=this.parseExpression();return this.assertKeywordToken(this.currentToken(),"do"),++this.position,new n.While(t.position,e,this.parseExpression())}if(this.checkKeywordToken(t,"fn"))return++this.position,new n.Lambda(t.position,this.parseMatch());for(var r=this.parseInfixExpression(),o=this.currentToken();this.checkKeywordToken(o,":");)++this.position,r=new n.TypedExpression(t.position,r,this.parseType()),o=this.currentToken();return r},Parser.prototype.parseExpression=function(){var t=this.parseAppendedExpression(),e=this.currentToken(),i=e;if(this.checkKeywordToken(e,"andalso")||this.checkKeywordToken(e,"orelse")){for(var r=[[t,[0]]],o=[],a=0;;){if(this.checkKeywordToken(e,"orelse"))o.push([1,a++]),++this.position;else{if(!this.checkKeywordToken(e,"andalso"))break;o.push([0,a++]),++this.position}r.push([this.parseAppendedExpression(),[a]]),e=this.currentToken()}o.sort();for(var s=0;s<o.length;++s){var u=r[o[s][1]][0],p=r[o[s][1]+1][0],c=void 0;c=0===o[s][0]?new n.Conjunction(u.position,u,p):new n.Disjunction(u.position,u,p);for(var h=r[o[s][1]][1],l=0,f=r[o[s][1]+1][1];l<f.length;l++){var d=f[l];h.push(d)}for(var y=0,v=h;y<v.length;y++){var d=v[y];r[d]=[c,h]}}t=r[0][0]}for(e=this.currentToken();this.checkKeywordToken(e,"handle");)++this.position,t=new n.HandleException(i.position,t,this.parseMatch()),e=this.currentToken();return t},Parser.prototype.parseMatch=function(){for(var t=this.currentToken(),e=[];;){var i=this.parsePattern();this.assertKeywordToken(this.currentToken(),"=>"),++this.position;var r=this.parseExpression();if(e.push([i,r]),!this.checkKeywordToken(this.currentToken(),"|"))break;++this.position}return new n.Match(t.position,e)},Parser.prototype.parsePatternRow=function(){for(var t=this.currentToken(),e=[],i=!0,a=!0;;){var s=this.currentToken();if(this.checkKeywordToken(s,"}"))return++this.position,new n.Record(t.position,a,e);if(!a)throw new r.ParserError("Record wildcard must appear as last element of the record.",s.position);if(i||!this.checkKeywordToken(s,","))if(i=!1,this.checkKeywordToken(s,"..."))a=!1,++this.position;else{if(!s.isValidRecordLabel())throw new r.ParserError('Expected "}", "...", or identifier.',s.position);++this.position;var u=this.currentToken();if(!(u instanceof o.KeywordToken))throw new r.ParserError('Expected ":", "as", ",", or "=", got '+u.getText()+'".',u.position);if("="===u.text){++this.position,e.push([s.getText(),this.parsePattern()]);continue}var p=void 0;if(s instanceof o.NumericToken)throw new r.ParserError('You cannot assign to "'+s.getText()+'".',s.position);var c=new n.ValueIdentifier(s.position,s);":"===u.text&&(++this.position,p=this.parseType(),u=this.currentToken()),"as"===u.text?(++this.position,c=new n.LayeredPattern(c.position,c.name,p,this.parsePattern()),u=this.currentToken()):void 0!==p&&(c=new n.TypedExpression(c.position,c,p)),e.push([s.getText(),c])}else++this.position}},Parser.prototype.parseAtomicPattern=function(){if(this.position>=this.tokens.length)throw new r.ParserError("Unexpected end of token stream",-1);var t=this.currentToken();if(this.checkKeywordToken(t,"op")){++this.position;var e=this.currentToken();this.assertIdentifierOrLongToken(e),e.opPrefixed=!0,++this.position;var i=this.position;try{if(!(e instanceof o.LongIdentifierToken)){var a=this.currentToken(),s=void 0;return this.checkKeywordToken(a,":")&&(++this.position,s=this.parseType(),a=this.currentToken()),this.assertKeywordToken(a,"as"),++this.position,new n.LayeredPattern(t.position,e,s,this.parsePattern())}}catch(t){this.position=i}return new n.ValueIdentifier(t.position,e)}if(this.checkKeywordToken(t,"_"))return++this.position,new n.Wildcard(t.position);if(this.checkKeywordToken(t,"{")){++this.position;return this.parsePatternRow()}if(this.checkKeywordToken(t,"(")){if(++this.position,this.checkKeywordToken(this.currentToken(),")"))return++this.position,new n.Tuple(t.position,[]);for(var u=[this.parsePattern()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,")"))return++this.position,1===u.length?u[0]:new n.Tuple(t.position,u);throw new r.ParserError('Expected "," or ")", but got "'+e.getText()+'".',e.position)}++this.position,u.push(this.parsePattern())}}if(this.checkKeywordToken(t,"[")){if(++this.position,this.checkKeywordToken(this.currentToken(),"]"))return++this.position,new n.List(t.position,[]);for(var u=[this.parsePattern()];;){var e=this.currentToken();if(!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,"]"))return++this.position,new n.List(t.position,u);throw new r.ParserError('Expected "," or "]" but found "'+e.getText()+'".',e.position)}++this.position,u.push(this.parsePattern())}}else{if(t instanceof o.ConstantToken)return++this.position,new n.Constant(t.position,t);if(t instanceof o.IdentifierToken||t instanceof o.LongIdentifierToken){++this.position;var i=this.position;try{if(!(t instanceof o.LongIdentifierToken)){var a=this.currentToken(),s=void 0;return this.checkKeywordToken(a,":")&&(++this.position,s=this.parseType(),a=this.currentToken()),this.assertKeywordToken(a,"as"),++this.position,new n.LayeredPattern(t.position,t,s,this.parsePattern())}}catch(t){this.position=i}return new n.ValueIdentifier(t.position,t)}}throw new r.ParserError('Expected atomic pattern but got "'+t.getText()+'".',t.position)},Parser.prototype.parseApplicationPattern=function(){for(var t=this.currentToken(),e=this.parseAtomicPattern();;){var i=this.position,r=this.currentToken();if(this.checkVidOrLongToken(r)&&void 0!==this.state.getInfixStatus(r)&&this.state.getInfixStatus(r).infix)break;try{var o=this.parseAtomicPattern();e=new n.FunctionApplication(t.position,e,o)}catch(t){this.position=i;break}}return e},Parser.prototype.parseInfixPattern=function(){for(var t=[],e=[],i=0;;){t.push(this.parseApplicationPattern());var r=this.currentToken();if(!this.checkIdentifierOrLongToken(r)||void 0===this.state.getInfixStatus(r)||!this.state.getInfixStatus(r).infix)break;++this.position,e.push([r,i++])}return 0===i?t[0]:new n.InfixExpression(t,e).reParse(this.state)},Parser.prototype.parsePattern=function(){for(var t=this.currentToken(),e=this.parseInfixPattern();this.checkKeywordToken(this.currentToken(),":");)++this.position,e=new n.TypedExpression(t.position,e,this.parseType());return e},Parser.prototype.parseTypeRow=function(){for(var t=this.currentToken(),e=new Map,n=!0;;){var a=this.currentToken();if(this.checkKeywordToken(a,"}"))return++this.position,new i.RecordType(e,!0,t.position);{if(n||!this.checkKeywordToken(a,",")){if(n=!1,a.isValidRecordLabel()){++this.position;var s=this.currentToken();if(!(s instanceof o.KeywordToken))throw new r.ParserError('Expected ":".',s.position);if(":"===s.text){if(++this.position,e.has(a.getText()))throw new r.ParserError('Duplicate record label "'+a.getText()+'".',a.position);e.set(a.getText(),this.parseType());continue}throw new r.ParserError('Expected ":".',s.position)}throw new r.ParserError('Expected "}", or an identifier, got "'+a.getText()+'".',a.position)}++this.position}}},Parser.prototype.parseSimpleType=function(){var t=this.currentToken();if(t instanceof o.TypeVariableToken)return++this.position,new i.TypeVariable(t.getText(),!0,t.position);if(this.checkIdentifierOrLongToken(t))return++this.position,new i.CustomType(t.getText(),[],t.position);if(this.checkKeywordToken(t,"{"))return++this.position,this.parseTypeRow();if(this.checkKeywordToken(t,"(")){if(++this.position,this.checkKeywordToken(this.currentToken(),")"))throw new r.ParserError('Use "{}" or "unit" to denote the unit type.',this.currentToken().position);for(var e=[this.parseType()];;){var n=this.currentToken();{if(!this.checkKeywordToken(n,",")){if(this.checkKeywordToken(n,")")){if(++this.position,1===e.length)return e[0];this.assertIdentifierOrLongToken(this.currentToken());var a=this.currentToken();return++this.position,new i.CustomType(a.getText(),e,t.position)}throw new r.ParserError('Expected "," or ")", got "'+n.getText()+'".',n.position)}++this.position,e.push(this.parseType())}}}throw new r.ParserError('Expected either "(" or "{" got "'+t.getText()+'".',t.position)},Parser.prototype.parseType=function(){var t=this.parseTupleType(),e=this.currentToken();if(!this.checkKeywordToken(e,"->"))return t;++this.position;var n=this.parseType();return new i.FunctionType(t,n,e.position)},Parser.prototype.parseTupleType=function(){for(var t=[this.parseCustomType()],e=this.currentToken(),n=e.position;this.checkKeywordToken(this.currentToken(),"*");)++this.position,t.push(this.parseCustomType());return 1===t.length?t[0]:new i.TupleType(t,n)},Parser.prototype.parseCustomType=function(){for(var t=this.currentToken(),e=this.parseSimpleType();this.position<this.tokens.length;){var n=this.currentToken();if(!this.checkIdentifierOrLongToken(n))return e;if(void 0!==this.state.getCustomType(n.getText())&&0===this.state.getCustomType(n.getText()).arity)return e;++this.position,e=new i.CustomType(n.getText(),[e],t.position)}return e},Parser.prototype.parseValueBinding=function(){var t=this.currentToken();if(this.checkKeywordToken(t,"rec")){++this.position;var e=this.parseValueBinding();return e.position=t.position,e.isRecursive=!0,e}var n=this.parsePattern();return this.assertKeywordToken(this.currentToken(),"="),++this.position,new a.ValueBinding(t.position,!1,n,this.parseExpression())},Parser.prototype.parseFunctionValueBinding=function(){for(var t=this.currentToken(),e=[],i=-1,o=void 0;;){var s=[],u=void 0,p=void 0;if(this.checkKeywordToken(this.currentToken(),"(")){var c=this.parsePattern();if(!(c instanceof n.FunctionApplication&&c.argument.simplify()instanceof n.Record&&2===c.argument.simplify().entries.length&&c.func instanceof n.ValueIdentifier))throw new r.ParserError('If you start a function declaration with a "(", some infix expression should follow. But you gave me "'+c.prettyPrint()+'" ('+c.constructor.name+").",c.position);p=c.func,s.push(c.argument)}else{var h=this.position,l=!1,f=!1;try{var d=this.parseOpIdentifierToken();if(p=new n.ValueIdentifier(d.position,d),void 0!==this.state.getInfixStatus(p.name)&&this.state.getInfixStatus(p.name).infix&&!p.name.opPrefixed)throw l=!0,new r.ParserError('Missing "op".',p.name.position);for(;;){if(this.checkKeywordToken(this.currentToken(),"=")||this.checkKeywordToken(this.currentToken(),":"))break;var c=this.parseAtomicPattern();if(c instanceof n.ValueIdentifier&&void 0!==this.state.getInfixStatus(c.name)&&this.state.getInfixStatus(c.name).infix)throw f=!0,new r.ParserError('Cute little infix identifiers such as "'+c.prettyPrint()+'" sure should play somewhere else.',c.position);s.push(c)}}catch(t){if(l)throw t;l=!1;try{this.position=h;var y=this.parseAtomicPattern();if(this.assertIdentifierOrLongToken(this.currentToken()),p=new n.ValueIdentifier(this.currentToken().position,this.currentToken()),void 0===this.state.getInfixStatus(this.currentToken())||!this.state.getInfixStatus(this.currentToken()).infix){if(f)throw l=!0,t;throw new r.ParserError('"'+this.currentToken().getText()+'" does not have infix status.',this.currentToken().position)}++this.position;var v=this.parseAtomicPattern();s.push(new n.Tuple(-1,[y,v]))}catch(e){throw t}}}if(this.checkKeywordToken(this.currentToken(),":")&&(++this.position,u=this.parseType()),this.assertKeywordToken(this.currentToken(),"="),++this.position,-1===i)i=s.length;else if(2!==i&&3!==i&&i!==s.length)throw new r.ParserError("Different number of arguments.",t.position);if(0===i)throw new r.ParserError('Functions need arguments to survive. Rely on "val" instead.',t.position);if(void 0===o)o=p;else if(p.name.getText()!==o.name.getText())throw new r.ParserError('Different function names in different cases ("'+p.name.getText()+'" vs. "'+o.name.getText()+'")',t.position);if(e.push([s,u,this.parseExpression()]),!this.checkKeywordToken(this.currentToken(),"|"))break;++this.position}return new a.FunctionValueBinding(t.position,e,o)},Parser.prototype.parseTypeBinding=function(){var t=this.currentToken(),e=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());var n=this.currentToken();return++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position,new a.TypeBinding(t.position,e,n,this.parseType())},Parser.prototype.parseTypeBindingSeq=function(){for(var t=[];;){if(t.push(this.parseTypeBinding()),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return t},Parser.prototype.parseExceptionBinding=function(){var t=this.currentToken(),e=this.parseOpIdentifierToken();if(this.checkKeywordToken(this.currentToken(),"of")){++this.position;var n=this.parseType();return new a.DirectExceptionBinding(t.position,e,n)}if(this.checkKeywordToken(this.currentToken(),"=")){++this.position;var i=this.parseOpIdentifierToken(!0);return new a.ExceptionAlias(t.position,e,i)}return new a.DirectExceptionBinding(t.position,e,void 0)},Parser.prototype.parseDatatypeBinding=function(){var t=this.currentToken(),e=this.parseTypeVarSequence();this.assertIdentifierToken(this.currentToken());var n=this.currentToken();++this.position,this.assertKeywordToken(this.currentToken(),"="),++this.position;for(var i=[];;){var r=this.parseOpIdentifierToken();if(this.checkKeywordToken(this.currentToken(),"of")){++this.position;var o=this.parseType();i.push([r,o])}else i.push([r,void 0]);if(!this.checkKeywordToken(this.currentToken(),"|"))break;++this.position}return new a.DatatypeBinding(t.position,e,n,i)},Parser.prototype.parseDatatypeBindingSeq=function(){for(var t=[];;){if(t.push(this.parseDatatypeBinding()),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return t},Parser.prototype.parseTypeVarSequence=function(t){void 0===t&&(t=!1);var e=this.currentToken(),n=[];if(e instanceof o.TypeVariableToken)return n.push(new i.TypeVariable(e.text,!1,e.position)),++this.position,n;if(this.checkKeywordToken(e,"("))for(++this.position;;){if(!((e=this.currentToken())instanceof o.TypeVariableToken)){if(t)return;throw new r.ParserError("Expected a type varible.",e.position)}if(n.push(new i.TypeVariable(e.text,!1,e.position)),++this.position,e=this.currentToken(),!this.checkKeywordToken(e,",")){if(this.checkKeywordToken(e,")")){++this.position;break}throw new r.ParserError('Expected "," or ")" but got "'+e.getText()+'".',e.position)}++this.position}return n},Parser.prototype.parseDeclaration=function(t){void 0===t&&(t=!1);for(var e=[],n=this.currentToken(),i=this.currentId++;this.position<this.tokens.length;){var r=this.parseSimpleDeclaration(t);if(r instanceof a.EmptyDeclaration){if(this.position>=this.tokens.length||this.checkKeywordToken(this.currentToken(),"in")||this.checkKeywordToken(this.currentToken(),"end"))break}else e.push(r),this.checkKeywordToken(this.currentToken(),";")&&++this.position}return new a.SequentialDeclaration(n.position,e,i)},Parser.prototype.parseSimpleDeclaration=function(t){void 0===t&&(t=!1);var e=this.currentToken(),i=this.currentId++;if(this.checkKeywordToken(e,"val")){++this.position;var s=this.parseTypeVarSequence(!0);void 0===s&&(--this.position,s=[]);for(var u=[],p=!1;;){var c=this.parseValueBinding();if(c.isRecursive){if(p=!0,!(c.expression instanceof n.Lambda))throw new r.ParserError('Using "rec" requires binding a lambda.',c.position);if(!(c.pattern instanceof n.ValueIdentifier||c.pattern instanceof n.Wildcard))throw new r.ParserError('Using "rec" requires binding to a single identifier and not "'+c.pattern.prettyPrint(0,!0)+'".',c.position)}if(c.isRecursive=p,u.push(c),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new a.ValueDeclaration(e.position,s,u,i)}if(this.checkKeywordToken(e,"fun")){++this.position;var s=this.parseTypeVarSequence(!0);void 0===s&&(--this.position,s=[]);for(var h=[];;){if(h.push(this.parseFunctionValueBinding()),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new a.FunctionDeclaration(e.position,s,h,i)}if(this.checkKeywordToken(e,"type"))return++this.position,new a.TypeDeclaration(e.position,this.parseTypeBindingSeq(),i);if(this.checkKeywordToken(e,"datatype")){if(this.position+3<this.tokens.length&&this.checkKeywordToken(this.tokens[this.position+3],"datatype")){++this.position;var l=this.currentToken();this.assertIdentifierToken(l),this.position+=2;var f=this.currentToken();return this.assertIdentifierOrLongToken(f),new a.DatatypeReplication(e.position,l,f,i)}++this.position;var d=this.parseDatatypeBindingSeq();if(this.checkKeywordToken(this.currentToken(),"withtype")){++this.position;var y=this.parseTypeBindingSeq();return new a.DatatypeDeclaration(e.position,d,y,i)}return new a.DatatypeDeclaration(e.position,d,void 0,i)}if(this.checkKeywordToken(e,"abstype")){++this.position;var v=this.state;this.state=this.state.getNestedState(this.state.id);var d=this.parseDatatypeBindingSeq(),w=void 0;this.checkKeywordToken(this.currentToken(),"withtype")&&(++this.position,w=this.parseTypeBindingSeq()),this.assertKeywordToken(this.currentToken(),"with"),++this.position;var T=this.parseDeclaration();return this.assertKeywordToken(this.currentToken(),"end"),++this.position,this.state=v,new a.AbstypeDeclaration(e.position,d,w,T,i)}if(this.checkKeywordToken(e,"exception")){++this.position;for(var m=[];;){if(m.push(this.parseExceptionBinding()),!this.checkKeywordToken(this.currentToken(),"and"))break;++this.position}return new a.ExceptionDeclaration(e.position,m,i)}if(this.checkKeywordToken(e,"local")){++this.position;var v=this.state;this.state=this.state.getNestedState(this.state.id);var T=this.parseDeclaration();this.assertKeywordToken(this.currentToken(),"in"),++this.position;var g=this.parseDeclaration();return this.assertKeywordToken(this.currentToken(),"end"),++this.position,this.state=v,new a.LocalDeclaration(e.position,T,g,i)}if(this.checkKeywordToken(e,"open")){++this.position;for(var E=[];this.checkIdentifierOrLongToken(this.currentToken());)E.push(this.currentToken()),++this.position;if(0===E.length)throw new r.ParserError('Empty "open" declaration.',this.currentToken().position);return new a.OpenDeclaration(e.position,E,i)}if(this.checkKeywordToken(e,"infix")){++this.position;var I=0;if(this.currentToken()instanceof o.IntegerConstantToken){if(1!==this.currentToken().text.length)throw new r.ParserError("Precedences may only be single digits.",this.currentToken().position);I=this.currentToken().value,++this.position}for(var E=[];this.currentToken().isVid();)E.push(this.currentToken()),++this.position;if(0===E.length)throw new r.ParserError('Empty "infix" declaration.',this.currentToken().position);var x=new a.InfixDeclaration(e.position,E,I,i);return this.state=x.evaluate(this.state)[0],x}if(this.checkKeywordToken(e,"infixr")){++this.position;var I=0;if(this.currentToken()instanceof o.IntegerConstantToken){if(1!==this.currentToken().text.length)throw new r.ParserError("Precedences may only be single digits.",this.currentToken().position);I=this.currentToken().value,++this.position}for(var E=[];this.currentToken().isVid();)E.push(this.currentToken()),++this.position;if(0===E.length)throw new r.ParserError('Empty "infixr" declaration.',this.currentToken().position);var x=new a.InfixRDeclaration(e.position,E,I,i);return this.state=x.evaluate(this.state)[0],x}if(this.checkKeywordToken(e,"nonfix")){++this.position;for(var E=[];this.currentToken().isVid();)E.push(this.currentToken()),++this.position;if(0===E.length)throw new r.ParserError('Empty "nonfix" declaration.',this.currentToken().position);var x=new a.NonfixDeclaration(e.position,E,i);return this.state=x.evaluate(this.state)[0],x}if(this.checkKeywordToken(e,";"))return++this.position,new a.EmptyDeclaration(i);if(this.checkKeywordToken(e,"in")||this.checkKeywordToken(e,"end"))return new a.EmptyDeclaration(i);if(t){var k=this.parseExpression(),V=new a.ValueBinding(e.position,!1,new n.ValueIdentifier(-1,new o.AlphanumericIdentifierToken("it",-1)),k);return this.assertKeywordToken(this.currentToken(),";"),new a.ValueDeclaration(e.position,[],[V],i)}throw new r.ParserError("Expected a declaration.",e.position)},Parser.prototype.currentToken=function(){if(this.position>=this.tokens.length)throw new r.IncompleteError(-1,"More input, I'm starving. ~nyan.");return this.tokens[this.position]},Parser}();exports.Parser=s,exports.parse=parse},function(t,exports,e){"use strict";function addMathLib(t){return t.setDynamicValue("Math.sqrt",new r.PredefinedFunction("Math.sqrt",function(t){if(t instanceof r.Real){var e=t.value;return e<0?[new r.ExceptionConstructor("Domain").construct(),!0,[]]:[new r.Real(Math.sqrt(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.sqrt",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.sin",new r.PredefinedFunction("Math.sin",function(t){if(t instanceof r.Real){var e=t.value;return[new r.Real(Math.sin(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.sin",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.cos",new r.PredefinedFunction("Math.cos",function(t){if(t instanceof r.Real){var e=t.value;return[new r.Real(Math.cos(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.cos",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.asin",new r.PredefinedFunction("Math.asin",function(t){if(t instanceof r.Real){var e=t.value;return[new r.Real(Math.asin(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.asin",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.acos",new r.PredefinedFunction("Math.acos",function(t){if(t instanceof r.Real){var e=t.value;return[new r.Real(Math.acos(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.acos",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.exp",new r.PredefinedFunction("Math.exp",function(t){if(t instanceof r.Real){var e=t.value;return[new r.Real(Math.exp(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.exp",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.pow",new r.PredefinedFunction("Math.sin",function(t){if(t instanceof r.RecordValue){var e=t.getValue("1"),n=t.getValue("2");if(e instanceof r.Real&&n instanceof r.Real){var i=e.value,a=e.value;return[new r.Real(Math.pow(i,a)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.pow",new i.FunctionType(new i.TupleType([u,u]),u).simplify(),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.ln",new r.PredefinedFunction("Math.ln",function(t){if(t instanceof r.Real){var e=t.value;return[new r.Real(Math.log(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.ln",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.log10",new r.PredefinedFunction("Math.log10",function(t){if(t instanceof r.Real){var e=t.value;return[new r.Real(Math.log10(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.log10",new i.FunctionType(u,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.pi",new r.Real(3.14159265359),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.pi",u,n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Math.e",new r.Real(2.71828182846),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Math.e",u,n.IdentifierStatus.VALUE_VARIABLE),t}function addCharLib(t){return t.setDynamicValue("ord",new r.PredefinedFunction("ord",function(t){if(t instanceof r.CharValue){var e=t.value;return[new r.Integer(e.charCodeAt(0)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("ord",new i.FunctionType(p,s),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("chr",new r.PredefinedFunction("chr",function(t){if(t instanceof r.Integer){var e=t.value;return e<0||e>255?[new r.ExceptionConstructor("Chr").construct(),!0,[]]:[new r.CharValue(String.fromCharCode(e)),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("chr",new i.FunctionType(s,p),n.IdentifierStatus.VALUE_VARIABLE),t}function addRealLib(t){return t.setDynamicValue("Real.fromInt",new r.PredefinedFunction("Real.fromInt",function(t){if(t instanceof r.Integer){var e=t.value;return[new r.Real(e),!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Real.fromInt",new i.FunctionType(s,u),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Real.round",new r.PredefinedFunction("Real.round",function(t){if(t instanceof r.Real){var e=t.value,n=new r.Integer(Math.round(e));return n.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[n,!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Real.round",new i.FunctionType(u,s),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Real.floor",new r.PredefinedFunction("Real.floor",function(t){if(t instanceof r.Real){var e=t.value,n=new r.Integer(Math.floor(e));return n.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[n,!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Real.floor",new i.FunctionType(u,s),n.IdentifierStatus.VALUE_VARIABLE),t.setDynamicValue("Real.ceil",new r.PredefinedFunction("Real.ceil",function(t){if(t instanceof r.Real){var e=t.value,n=new r.Integer(Math.round(e));return n.hasOverflow()?[new r.ExceptionConstructor("Overflow").construct(),!0,[]]:[n,!1,[]]}throw new o.InternalInterpreterError(-1,"std type mismatch")}),n.IdentifierStatus.VALUE_VARIABLE),t.setStaticValue("Real.ceil",new i.FunctionType(u,s),n.IdentifierStatus.VALUE_VARIABLE),t}function addStdLib(t,e){return t=a.interpret(c,t,e).state,t=addMathLib(t),t=addCharLib(t),t=addRealLib(t)}Object.defineProperty(exports,"__esModule",{value:!0});var n=e(2),i=e(3),r=e(4),o=e(0),a=e(8),s=new i.CustomType("int"),u=new i.CustomType("real"),p=new i.CustomType("char"),c='\nexception Domain;\nexception Empty;\nexception Subscript;\nexception Size;\nexception Chr;\n\nfun o (f,g) x = f (g x);\ninfix 3 o;\n\ndatatype order = LESS | EQUAL | GREATER;\n\nfun Int.compare (x, y: int) = if x<y then LESS else if x>y then GREATER else EQUAL;\nfun Real.compare (x, y: real) = if x<y then LESS else if x>y then GREATER else EQUAL;\n\nexception Option.Option;\ndatatype \'a option = NONE | SOME of \'a;\nfun valOf (SOME x) = x\n  | valOf NONE = raise Option.Option;\nfun isSome NONE = false\n  | isSome (SOME _) = true;\n\nval Int.minInt = SOME ~1073741824;\nval Int.maxInt = SOME 1073741823;\nfun Int.max (x, y) = if x < y then y else x : int;\n\nfun not true = false | not false = true;\n\nfun hd nil = raise Empty\n| hd (x::xr) = x;\nfun tl nil = raise Empty\n| tl (x::xr) = xr;\nfun null nil = true\n| null (x::xr) = false;\n\nfun map f nil = nil\n  | map f (x::xr) = (f x) :: (map f xr);\n\nfun @ (nil,ys) = ys\n| @((x::xr),ys) = x:: @(xr,ys);\ninfixr 5 @;\n\nfun length nil = 0\n  | length (x::xr) = 1 + length xr;\n\nfun rev nil = nil\n  | rev (x::xr) = rev xr @ [x];\n\nfun List.concat nil = nil\n  | List.concat (x::xr) = x @ List.concat xr;\n\nfun foldr f e []      = e\n  | foldr f e (x::xr) = f(x, foldr f e xr);\n\nfun foldl f e []      = e\n  | foldl f e (x::xr) = foldl f (f(x, e)) xr;\n\nfun List.tabulate (n, f) =\n  let fun h i = if i<n then f i :: h (i+1) else []\n  in if n<0 then raise Size else h 0 end;\n\nfun List.exists p []      = false\n  | List.exists p (x::xr) = p x orelse List.exists p xr;\n\nfun List.all p []      = true\n  | List.all p (x::xr) = p x andalso List.all p xr;\n\nfun List.filter p []      = []\n  | List.filter p (x::xr) = if p x then x :: List.filter p xr else List.filter p xr;\n\nfun List.collate (compare : \'a * \'a -> order) p = case p of\n    (nil, _::_) => LESS\n  | (nil, nil) => EQUAL\n  | (_::_, nil) => GREATER\n  | (x::xr, y::yr) => case compare(x,y) of\n         EQUAL => List.collate compare (xr,yr)\n       | s => s;\n\nfun List.nth (xs, n) =\n    let fun h []      _ = raise Subscript\n      | h (x::xr) n = if n=0 then x else h xr (n-1)\n    in if n<0 then raise Subscript else h xs n end;\n\nfun Char.isLower c  = #"a" <= c andalso c <= #"z";\nfun Char.isUpper c  = #"A" <= c andalso c <= #"Z";\nfun Char.isDigit c  = #"0" <= c andalso c <= #"9";\nfun Char.isAlpha c  = Char.isLower c orelse Char.isUpper c;\n';exports.addStdLib=addStdLib}]);